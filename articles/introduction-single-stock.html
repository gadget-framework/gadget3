<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to gadget3: A single stock model • gadget3</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Introduction to gadget3: A single stock model">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.12-1-999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction-single-stock.html">Introduction to gadget3: A single stock model</a>
    </li>
    <li>
      <a href="../articles/incorporating-observation-data.html">Incorporating observation data into models</a>
    </li>
    <li>
      <a href="../articles/multiple-substocks.html">Modelling maturity &amp; sex with multiple stocks</a>
    </li>
    <li>
      <a href="../articles/model-customisation.html">Model customisation</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Spawning &amp; Random effects</a>
    </li>
    <li>
      <a href="../articles/model-debugging.html">Debugging a gadget3 model</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/model-structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/writing_actions.html">Writing G3 Actions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/gadget-framework/gadget3/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to gadget3: A single stock
model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gadget-framework/gadget3/blob/master/vignettes/introduction-single-stock.Rmd" class="external-link"><code>vignettes/introduction-single-stock.Rmd</code></a></small>
      <div class="hidden name"><code>introduction-single-stock.Rmd</code></div>

    </div>

    
    
<style type="text/css">
.hide {
  display: none!important;
}

/* https://bookdown.org/yihui/rmarkdown-cookbook/html-css.html */
.modelScript pre, .modelScript pre.sourceCode code {
  background-color: #f0f8ff !important;
}
</style>
<p>This vignette walks through a script that will generate a gadget3
model, explaining concepts along the way.</p>
<p>Code blocks that make up the gadget3 script are marked in blue, like
this:</p>
<div class="modelScript">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Introduction to gadget3: A single stock model</span></span></code></pre></div>
</div>
<p>When combined they will form a full model, see <a href="#appendix-full-model-script">the appendix for the entire
script</a>.</p>
<div class="section level2">
<h2 id="gadget3-and-the-gadget-framework">Gadget3 and the gadget framework<a class="anchor" aria-label="anchor" href="#gadget3-and-the-gadget-framework"></a>
</h2>
<p>Gadget3 is a marine modelling R package, but it is not in itself an
ecosystem model. Instead, it gives you building blocks (or
<em>actions</em>) that can be assembled to produce as complex model as
your situation requires. This can then be converted into other forms,
most importantly a <a href="https://CRAN.R-project.org/package=TMB" class="external-link">TMB</a> objective function
or an R function, which can then be optimised and run to generate
reporting.</p>
<p>As the name suggests, it’s designed to be a successor to the previous
<a href="https://cran.r-project.org/package=gadget2" class="external-link">gadget</a>
modelling framework. The actions currently available are designed to be
very similar, if not identical, to the components present in gadget2. If
you are familiar with previous versions of gadget then you will find the
naming very similar, and translation of old input files to gadget3 can
be done in a rote fashion.</p>
<p>Gadget3 is the core part of what is known as the <em>gadget
framework</em>, a set of packages that are designed to work together to
produce ecosystem models.</p>
<ul>
<li>
<a href="https://cran.r-project.org/package=gadget3" class="external-link">gadget3</a>:
The core package, assembles ecosystem models from R code</li>
<li>
<a href="https://cran.r-project.org/package=mfdb" class="external-link">MFDB</a>: The
data-handling package, to help aggregating &amp; formatting time-series
data suitable for using as inputs to your model</li>
<li>
<a href="https://github.com/gadget-framework/gadgetutils" class="external-link">gadgetutils</a>:
A set of utilities to help produce an optimised model</li>
<li>
<a href="https://github.com/gadget-framework/gadgetplots" class="external-link">gadgetplots</a>:
Tools to produce plots and HTML pages summarising model output</li>
<li>
<a href="https://github.com/gadget-framework/g3experiments" class="external-link">g3experiments</a>:
Additional actions / features not yet ready for inclusion in
gadget3</li>
<li>
<a href="https://github.com/gadget-framework/modelwizard" class="external-link">modelwizard</a>:
A GUI package to assist in building in model scripts, both for gadget3
and SS3</li>
</ul>
<p>These packages are loosely coupled; you do not need everything
installed to create a gadget3 model. However, when they will prove
useful it will be mentioned here.</p>
<p>The <code>gadget3</code> package can be installed via. CRAN:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'gadget3'</span><span class="op">)</span></span></code></pre></div>
<p>The full set of packages can be installed with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'MFDB'</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'gadget-framework/gadgetutils'</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'gadget-framework/gadgetplots'</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'gadget-framework/g3experiments'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-single-species-model">Creating a (single species) model<a class="anchor" aria-label="anchor" href="#creating-a-single-species-model"></a>
</h2>
<p>As opposed gadget2 and other modelling frameworks, there is no input
data format. Instead, the model configuration is written as an R script.
This document will walk through the parts of a model script for a
single-species model, introducing concepts along the way.</p>
<p>The first step in any script is to load <code>gadget3</code>. We will
also use <code>dplyr</code> when formatting input data:</p>
<div class="modelScript">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gadget-framework.github.io/gadget3/" class="external-link">gadget3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="actions">Actions<a class="anchor" aria-label="anchor" href="#actions"></a>
</h3>
<p>A gadget3 model is defined as a list of <em>actions</em>.
<em>Actions</em> are snippets of code that define processes in a
model.</p>
<p>To start with, we will add the <code><a href="../reference/action_time.html">g3a_time()</a></code> to our list of
actions:</p>
<div class="modelScript">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create time definitions ####################</span></span>
<span></span>
<span><span class="va">actions_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span></span>
<span>    <span class="fl">1979L</span>, <span class="fl">2023L</span>,</span>
<span>    step_lengths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">3L</span>, <span class="fl">3L</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="va">actions_time</span><span class="op">)</span></span></code></pre></div>
</div>
<p>This acts as timekeeping for our model, starting in year 1979 and
progressing until 2023. Each year will have 4 time steps in, of equal
length.</p>
<p>As a convention, we build up an <code>actions</code> array of
everything required, allowing sections to be added/removed as
necessary.</p>
<p>Ultimately, this list will be converted to either R or TMB code with
with <code><a href="../reference/run_r.html">g3_to_r()</a></code> or <code><a href="../reference/run_tmb.html">g3_to_tmb()</a></code> respectively. We
can try this already with our time action, and generate a function that
will count years &amp; steps:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="va">actions_time</span><span class="op">)</span></span></code></pre></div>
<pre><code>function (param) 
{
    stopifnot("retro_years" %in% names(param))
    assert_msg &lt;- function(expr, message) {
        if (isFALSE(expr)) {
            warning(message)
            return(TRUE)
        }
        return(FALSE)
    }
    cur_time &lt;- -1L
    stopifnot("project_years" %in% names(param))
    project_years &lt;- param[["project_years"]]
    cur_year &lt;- 0L
    start_year &lt;- 1979L
    step_count &lt;- length(step_lengths)
    cur_year_projection &lt;- FALSE
    end_year &lt;- 2023L
    cur_step &lt;- 0L
    cur_step_size &lt;- step_lengths[[1]]/12
    cur_step_final &lt;- FALSE
    retro_years &lt;- param[["retro_years"]]
    total_steps &lt;- length(step_lengths) * (end_year - retro_years - 
        start_year + project_years) + length(step_lengths) - 
        1L
    nll &lt;- 0
    while (TRUE) {
        {
            comment("g3a_time: Start of time period")
            cur_time &lt;- cur_time + 1L
            if (cur_time == 0 &amp;&amp; assert_msg(param[["retro_years"]] &gt;= 
                0, "retro_years must be &gt;= 0")) 
                return(NaN)
            if (cur_time == 0 &amp;&amp; assert_msg(project_years &gt;= 
                0, "project_years must be &gt;= 0")) 
                return(NaN)
            cur_year &lt;- start_year + (cur_time%/%step_count)
            cur_year_projection &lt;- cur_year &gt; end_year - param[["retro_years"]]
            cur_step &lt;- (cur_time%%step_count) + 1L
            cur_step_size &lt;- step_lengths[[cur_step]]/12
            cur_step_final &lt;- cur_step == step_count
        }
        {
            if (cur_time &gt; total_steps) 
                return(nll)
        }
    }
}
&lt;bytecode: 0x560a742a1fa0&gt;
&lt;environment: 0x560a770d34d8&gt;</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_tmb.html">g3_to_tmb</a></span><span class="op">(</span><span class="va">actions_time</span><span class="op">)</span></span></code></pre></div>
<pre><code>#include &lt;TMB.hpp&gt;



template&lt;class Type&gt;
Type objective_function&lt;Type&gt;::operator() () {
    DATA_SCALAR(reporting_enabled); DATA_UPDATE(reporting_enabled);
    PARAMETER(retro_years);
    auto assert_msg = [](bool expr, std::string message) -&gt; bool {
    if (!expr) { Rf_warning(message.c_str()); return TRUE; }
    return FALSE;
};
    int cur_time = -1;
    PARAMETER(project_years);
    int cur_year = 0;
    int start_year = 1979;
    vector&lt;int&gt; step_lengths(4); step_lengths.setConstant(3);
    auto step_count = (step_lengths).size();
    int cur_year_projection = false;
    int end_year = 2023;
    int cur_step = 0;
    auto cur_step_size = step_lengths ( 0 ) / (double)(12);
    int cur_step_final = false;
    auto total_steps = (step_lengths).size()*(end_year - retro_years - start_year + project_years) + (step_lengths).size() - 1;
    Type nll = (double)(0);

    while (true) {
        {
            // g3a_time: Start of time period;
            cur_time += 1;
            if ( cur_time == 0 &amp;&amp; assert_msg(retro_years &gt;= (double)(0), "retro_years must be &gt;= 0") ) {
                return NAN;
            }
            if ( cur_time == 0 &amp;&amp; assert_msg(project_years &gt;= (double)(0), "project_years must be &gt;= 0") ) {
                return NAN;
            }
            cur_year = start_year + (((int) cur_time) / ((int) step_count));
            cur_year_projection = cur_year &gt; end_year - retro_years;
            cur_step = (cur_time % step_count) + 1;
            cur_step_size = step_lengths ( cur_step - 1 ) / (double)(12);
            cur_step_final = cur_step == step_count;
        }
        {
            if ( cur_time &gt; total_steps ) {
                return nll;
            }
        }
    }
}</code></pre>
</div>
<div class="section level3">
<h3 id="stocks">Stocks<a class="anchor" aria-label="anchor" href="#stocks"></a>
</h3>
<p>After actions, the other key concept in a gadget3 model is a
<em>stock</em>. These are the means to describe populations within your
model. For simpler scenarios such as here, stocks map directly to a
species. However, more complicated models may have one stock
per-maturation-stage, sex or both.</p>
<p>We define a stock with the <code><a href="../reference/stock.html">g3_stock()</a></code> and associated
<code>g3s_*</code> functions, for example:</p>
<div class="modelScript">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">area_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_areas.html">g3_areas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'IXa'</span>, <span class="st">'IXb'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create stock definition for fish ####################</span></span>
<span><span class="va">fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="st">"fish"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/stock_areas.html">g3s_livesonareas</a></span><span class="op">(</span><span class="va">area_names</span><span class="op">[</span><span class="st">"IXa"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/stock_age.html">g3s_age</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">5L</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Here we define a stock called “fish” with length bins 10..100, then
add an area to live in &amp; 5 age bins.</p>
<p>Ultimately, the stock functions define the structure of the arrays
that will hold the state of that stock within gadget3. We can use
<code><a href="../reference/stock.html">g3_stock_instance()</a></code> to see an example of the array
used:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># aperm() re-orders dimensions for more compact printing</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/aperm.html" class="external-link">aperm</a></span><span class="op">(</span><span class="fu"><a href="../reference/stock.html">g3_stock_instance</a></span><span class="op">(</span><span class="va">fish</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## , , area = IXa</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          age</span></span>
<span><span class="co">## length    age1 age2 age3 age4 age5</span></span>
<span><span class="co">##   10:20      0    0    0    0    0</span></span>
<span><span class="co">##   20:30      0    0    0    0    0</span></span>
<span><span class="co">##   30:40      0    0    0    0    0</span></span>
<span><span class="co">##   40:50      0    0    0    0    0</span></span>
<span><span class="co">##   50:60      0    0    0    0    0</span></span>
<span><span class="co">##   60:70      0    0    0    0    0</span></span>
<span><span class="co">##   70:80      0    0    0    0    0</span></span>
<span><span class="co">##   80:90      0    0    0    0    0</span></span>
<span><span class="co">##   90:100     0    0    0    0    0</span></span>
<span><span class="co">##   100:Inf    0    0    0    0    0</span></span></code></pre>
<p>For example, the abundance and mean weight of the stock will be
stored in one of these arrays within the model.</p>
</div>
<div class="section level3">
<h3 id="stock-actions">Stock actions<a class="anchor" aria-label="anchor" href="#stock-actions"></a>
</h3>
<p>Now we have a stock, we can add apply population dynamics
<em>actions</em>, and save them in the <code>actions</code> array from
earlier:</p>
<div class="modelScript">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">actions_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/action_grow.html">g3a_growmature</a></span><span class="op">(</span><span class="va">fish</span>, <span class="fu"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span><span class="op">(</span></span>
<span>    maxlengthgroupgrowth <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/action_naturalmortality.html">g3a_naturalmortality</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/action_renewal.html">g3a_initialconditions_normalcv</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/action_renewal.html">g3a_renewal_normalparam</a></span><span class="op">(</span><span class="va">fish</span>,</span>
<span>    run_step <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/action_age.html">g3a_age</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">actions_likelihood_fish</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/likelihood_understocking.html">g3l_understocking</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>, nll_breakdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="va">actions_fish</span>, <span class="va">actions_likelihood_fish</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Each of these <code>g3a_*</code> actions will have a 1:1 parallel
with gadget2 stockfile components, so if you are familiar with these
config files will do what you expect.</p>
<p>For each action you can click through to the reference to get more
information on what it does, but in summary we have defined:</p>
<ul>
<li>
<code><a href="../reference/action_grow.html">g3a_growmature()</a></code>: The growth model</li>
<li>
<code><a href="../reference/action_naturalmortality.html">g3a_naturalmortality()</a></code>: Natural mortality of our
stock</li>
<li>
<code><a href="../reference/action_renewal.html">g3a_initialconditions_normalcv()</a></code>: Initial recruitment,
defining numbers &amp; mean weights for the start of the model</li>
<li>
<code><a href="../reference/action_renewal.html">g3a_renewal_normalparam()</a></code>: Recruitment occuring every
spring (<code>run_step = 2</code>), independent of stock status</li>
<li>
<code><a href="../reference/action_age.html">g3a_age()</a></code>: Move fish through age groups at the end of a
year</li>
<li>
<code><a href="../reference/likelihood_understocking.html">g3l_understocking()</a></code>: A penalty applied to the
likelihood used to prevent more fish being eaten/fished than is
available.</li>
</ul>
<p>There are more actions available besides these, for instance
<code><a href="../reference/action_spawn.html">g3a_spawn()</a></code> can be used for recruitment dependent on stock
size instead of <code><a href="../reference/action_renewal.html">g3a_renewal_normalparam()</a></code>. For a full list,
see <code>??gadget3::"G3 action"</code> or the package reference
index.</p>
<p>Likelihood actions are actions that will sum their output into the
model’s overall likelihood score, analogous to gadget2’s <a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html" class="external-link">likelihood
components</a>.</p>
<p>The order of these actions as we have defined them is not preserved.
When a model runs, the steps will not happen in the above order, they
will be re-ordered to match the standard action order, see
<code><a href="../reference/action_order.html">?g3_action_order</a></code>.</p>
<div class="section level4">
<h4 id="model-parameters">Model parameters<a class="anchor" aria-label="anchor" href="#model-parameters"></a>
</h4>
<p>The definition above should look quite barren, bar
<code>maxlengthgroupgrowth</code> we have not provided any figures for
the stock dynamics.</p>
<p>The defaults for all actions define <em>model parameters</em> that
can be set as fixed values or optimised later, rather than baking them
into the model.</p>
<p>For instance, we can see that <code><a href="../reference/action_naturalmortality.html">g3a_naturalmortality()</a></code>
creates a parameter for <code>M</code> by default:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">g3a_naturalmortality</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                                            </span></span>
<span><span class="co">## 1 function (stock, mortality_f = g3a_naturalmortality_exp(), run_f = TRUE, </span></span>
<span><span class="co">## 2     run_at = g3_action_order$naturalmortality)                           </span></span>
<span><span class="co">## 3 {                                                                        </span></span>
<span><span class="co">## 4     out &lt;- new.env(parent = emptyenv())                                  </span></span>
<span><span class="co">## 5     action_name &lt;- unique_action_name()                                  </span></span>
<span><span class="co">## 6     stock__num &lt;- g3_stock_instance(stock, 0)</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">g3a_naturalmortality_exp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                                                   </span></span>
<span><span class="co">## 1 function (param_f = g3_parameterized("M", by_stock = by_stock,                  </span></span>
<span><span class="co">## 2     by_age = TRUE), by_stock = TRUE, action_step_size_f = ~cur_step_size)       </span></span>
<span><span class="co">## 3 {                                                                               </span></span>
<span><span class="co">## 4     f_substitute(~exp(-(param_f) * action_step_size_f), list(param_f = param_f, </span></span>
<span><span class="co">## 5         action_step_size_f = action_step_size_f))                               </span></span>
<span><span class="co">## 6 }</span></span></code></pre>
<p>Without any arguments, we use
<code><a href="../reference/action_naturalmortality.html">g3a_naturalmortality_exp()</a></code>, which sets <code>M</code> to be
<code>g3_parameterized("M", by_stock = TRUE, by_age = TRUE)</code>. This
tells gadget3 that a parameter <code>M</code> should be expected by the
model, that will both be broken down by stock (i.e. will include the
name of our stock), and each age within that stock.</p>
<p>We can define a model with just <code><a href="../reference/action_time.html">g3a_time()</a></code> and
<code><a href="../reference/action_renewal.html">g3a_initialconditions_normalcv()</a></code> to see the end result. To
be able to run the function you need to provide a list of parameter
values, the format of this list is defined by the attached <em>parameter
template</em>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1991</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/action_renewal.html">g3a_initialconditions_normalcv</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simple_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">simple_actions</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_report.html">g3a_report_detail</a></span><span class="op">(</span><span class="va">simple_actions</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simple_fn</span>, <span class="st">'parameter_template'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      retro_years        fish.Linf           fish.K          fish.t0 </span></span>
<span><span class="co">##              0.0              1.0              1.0              0.0 </span></span>
<span><span class="co">##       fish.lencv fish.init.scalar      fish.init.1      fish.init.2 </span></span>
<span><span class="co">##              0.1              1.0              1.0              1.0 </span></span>
<span><span class="co">##      fish.init.3      fish.init.4      fish.init.5         fish.M.1 </span></span>
<span><span class="co">##              1.0              1.0              1.0              0.0 </span></span>
<span><span class="co">##         fish.M.2         fish.M.3         fish.M.4         fish.M.5 </span></span>
<span><span class="co">##              0.0              0.0              0.0              0.0 </span></span>
<span><span class="co">##           init.F           recage      fish.walpha       fish.wbeta </span></span>
<span><span class="co">##              0.0              0.0              0.0              0.0 </span></span>
<span><span class="co">##    report_detail    project_years </span></span>
<span><span class="co">##              1.0              0.0</span></span></code></pre>
<p><code><a href="../reference/action_report.html">g3a_report_detail()</a></code> adds standard reporting to our
model, we will cover it’s use later.</p>
<p>We can fill in these values and run the model:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.scalar</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.1</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.2</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.3</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.4</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.init.5</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.M.1</span> <span class="op">&lt;-</span> <span class="fl">0.15</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.M.2</span> <span class="op">&lt;-</span> <span class="fl">0.15</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.M.3</span> <span class="op">&lt;-</span> <span class="fl">0.15</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.M.4</span> <span class="op">&lt;-</span> <span class="fl">0.15</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.M.5</span> <span class="op">&lt;-</span> <span class="fl">0.15</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">init.F</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">recage</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.Linf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"midlen"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.K</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"minage"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.8</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">fish.lencv</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">params</span><span class="op">$</span><span class="va">report_detail</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Run model and pull out final abundance from the result</span></span>
<span><span class="va">abund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">simple_fn</span><span class="op">(</span><span class="va">params</span><span class="op">)</span>, <span class="st">"detail_fish__num"</span><span class="op">)</span><span class="op">[</span>,area <span class="op">=</span> <span class="st">'IXa'</span>, , time <span class="op">=</span> <span class="st">'1990-01'</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">abund</span><span class="op">)</span><span class="op">$</span><span class="va">age</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">abund</span><span class="op">[</span>, age <span class="op">=</span> <span class="va">a</span><span class="op">]</span>, main <span class="op">=</span> <span class="va">a</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction-single-stock_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Altering K results in corresponding changes to the stock
structure:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">$</span><span class="va">fish.K</span> <span class="op">&lt;-</span> <span class="fl">0.9</span></span>
<span><span class="va">abund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">simple_fn</span><span class="op">(</span><span class="va">params</span><span class="op">)</span>, <span class="st">"detail_fish__num"</span><span class="op">)</span><span class="op">[</span>,area <span class="op">=</span> <span class="st">'IXa'</span>, , time <span class="op">=</span> <span class="st">'1990-01'</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">abund</span><span class="op">)</span><span class="op">$</span><span class="va">age</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">abund</span><span class="op">[</span>, age <span class="op">=</span> <span class="va">a</span><span class="op">]</span>, main <span class="op">=</span> <span class="va">a</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction-single-stock_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="fleet-actions">Fleet actions<a class="anchor" aria-label="anchor" href="#fleet-actions"></a>
</h3>
<p>Fleets in gadget3 are modelled as stock objects, which predate on
their target stocks.</p>
<p>To define a fleet, we need to introduce historical data into the
model. In our case we will generate random data, but the aggretation
steps would apply regardless.</p>
<div class="section level4">
<h4 id="landings-data">Landings data<a class="anchor" aria-label="anchor" href="#landings-data"></a>
</h4>
<div class="modelScript">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fleet data for f_surv #################################</span></span>
<span></span>
<span><span class="co"># Landings data: For each year/step/area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">1994</span>, step <span class="op">=</span> <span class="fl">2</span>, area <span class="op">=</span> <span class="st">'IXa'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Generate a random total landings by weight</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Assign result to landings_f_surv</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">landings_f_surv</span></span></code></pre></div>
</div>
<p>Here we use <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> to generate a
<code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> with all possible
<em>year</em>/<em>step</em>/<em>area</em> cominations. We then use
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code> to add a <em>weight</em> column to this
table, using <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm()</a></code> to generate random numbers distributed
about a mean.</p>
<p>The <code><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity()</a></code> function is a do-nothing function that
passes through the input. We use this to move the assignment onto it’s
own line.</p>
<p>The end result is a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> of total biomass
figures:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">landings_f_surv</span></span></code></pre></div>
<pre><code><span><span class="co">##   year step area    weight</span></span>
<span><span class="co">## 1 1990    2  IXa  943.9524</span></span>
<span><span class="co">## 2 1991    2  IXa  976.9823</span></span>
<span><span class="co">## 3 1992    2  IXa 1155.8708</span></span>
<span><span class="co">## 4 1993    2  IXa 1007.0508</span></span>
<span><span class="co">## 5 1994    2  IXa 1012.9288</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">landings_f_surv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'year'</span>, <span class="st">'weight'</span><span class="op">)</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2000</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction-single-stock_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>Note that we haven’t provided data for all years/steps, as we’ll
assume this fleet only works in spring. For more information on how this
works, see <code><a href="../articles/incorporating-observation-data.html">vignette("incorporating-observation-data")</a></code>.</p>
</div>
<div class="section level4">
<h4 id="length-distribution-data">Length distribution data<a class="anchor" aria-label="anchor" href="#length-distribution-data"></a>
</h4>
<p>Next we generate some length-distribution data:</p>
<div class="modelScript">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Length distribution data: Randomly generate 100 samples in each year/step/area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">1994</span>, step <span class="op">=</span> <span class="fl">2</span>, area <span class="op">=</span> <span class="st">'IXa'</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Generate random lengths for these samples</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Save unagggregated data into ldist_f_surv.raw</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ldist_f_surv.raw</span></span>
<span></span>
<span><span class="co"># Aggregate .raw data</span></span>
<span><span class="va">ldist_f_surv.raw</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group into length bins</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span></span>
<span>      year <span class="op">=</span> <span class="va">year</span>,</span>
<span>      step <span class="op">=</span> <span class="va">step</span>,</span>
<span>      length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">length</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Report count in each length bin</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>number <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">'keep'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Save into ldist_f_surv</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ldist_f_surv</span></span></code></pre></div>
</div>
<p>As before, <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>
generate a table with random lengths distributed about the mean. This is
our unaggregated data, which we save using <code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code> so we
can see the end result:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ldist_f_surv.raw</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   year step area   length</span></span>
<span><span class="co">## 1 1990    2  IXa 84.30130</span></span>
<span><span class="co">## 2 1991    2  IXa 59.21832</span></span>
<span><span class="co">## 3 1992    2  IXa 24.69878</span></span>
<span><span class="co">## 4 1993    2  IXa 36.26294</span></span>
<span><span class="co">## 5 1994    2  IXa 41.08676</span></span>
<span><span class="co">## 6 1990    2  IXa 74.48164</span></span></code></pre>
<p>We next use <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> and <code><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut()</a></code> to
aggregate by year, step &amp; length bins. <code><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut()</a></code> is
responsible for binning continuous data. We can see what it does by
running for single values:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] [40,60)</span></span>
<span><span class="co">## Levels: [0,20) [20,40) [40,60) [60,80) [80,Inf)</span></span></code></pre>
<p>Note that we add <code>Inf</code> to the end of the list of breaks,
to create a plus-group. We also specify <code>right = FALSE</code> so
that the groups are closed on the left.</p>
<p>Also note that our breaks aren’t the same as our stock definition,
this is allowed and gadget3 will re-aggregate the model data to match.
For more information on how this works, see
<code><a href="../articles/incorporating-observation-data.html">vignette("incorporating-observation-data")</a></code>.</p>
<p>Finally, summarise counts the number in each group and puts the
result into a <em>number</em> column. The end result looks like:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ldist_f_surv</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       year           step        length      number     </span></span>
<span><span class="co">##  Min.   :1990   Min.   :2   [0,20)  :5   Min.   : 2.00  </span></span>
<span><span class="co">##  1st Qu.:1991   1st Qu.:2   [20,40) :5   1st Qu.: 6.00  </span></span>
<span><span class="co">##  Median :1992   Median :2   [40,60) :5   Median :19.50  </span></span>
<span><span class="co">##  Mean   :1992   Mean   :2   [60,80) :5   Mean   :19.23  </span></span>
<span><span class="co">##  3rd Qu.:1993   3rd Qu.:2   [80,Inf):5   3rd Qu.:26.75  </span></span>
<span><span class="co">##  Max.   :1994   Max.   :2   NA's    :1   Max.   :46.00</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ldist_f_surv</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="va">years</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ldist_f_surv</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="va">y</span> <span class="op">&amp;</span> <span class="va">step</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">length</span>, <span class="va">number</span><span class="op">)</span>, main <span class="op">=</span> <span class="va">y</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction-single-stock_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="age-length-distribution-data">Age-length distribution data<a class="anchor" aria-label="anchor" href="#age-length-distribution-data"></a>
</h4>
<p>Finally, we can apply the same techniques to generate and aggregate
age-length data:</p>
<div class="modelScript">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assume 5 * 5 samples in each year/step/area</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">1994</span>, step <span class="op">=</span> <span class="fl">2</span>, area <span class="op">=</span> <span class="st">'IXa'</span>, age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">5</span><span class="op">)</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Generate random lengths/ages for these samples</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean <span class="op">=</span> <span class="fl">50</span>, sd <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Generate random whole numbers for age</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">1</span>, max <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Group into length/age bins</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span></span>
<span>      year <span class="op">=</span> <span class="va">year</span>,</span>
<span>      step <span class="op">=</span> <span class="va">step</span>,</span>
<span>      age <span class="op">=</span> <span class="va">age</span>,</span>
<span>      length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">length</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Report count in each length bin</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>number <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">'keep'</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>  <span class="va">aldist_f_surv</span></span></code></pre></div>
</div>
<p>The end result is a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> with
<em>year</em>/<em>step</em>/<em>age</em>/<em>length</em>/<em>number</em>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">aldist_f_surv</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       year           step        age             length       number     </span></span>
<span><span class="co">##  Min.   :1990   Min.   :2   Min.   :1.000   [0,20)  : 3   Min.   :1.000  </span></span>
<span><span class="co">##  1st Qu.:1991   1st Qu.:2   1st Qu.:1.250   [20,40) :14   1st Qu.:1.000  </span></span>
<span><span class="co">##  Median :1992   Median :2   Median :3.000   [40,60) :19   Median :2.000  </span></span>
<span><span class="co">##  Mean   :1992   Mean   :2   Mean   :2.552   [60,80) :15   Mean   :2.155  </span></span>
<span><span class="co">##  3rd Qu.:1993   3rd Qu.:2   3rd Qu.:3.750   [80,Inf): 5   3rd Qu.:3.000  </span></span>
<span><span class="co">##  Max.   :1994   Max.   :2   Max.   :4.000   NA's    : 2   Max.   :6.000</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">aldist_f_surv</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span><span class="va">ages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">aldist_f_surv</span><span class="op">$</span><span class="va">age</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ages</span><span class="op">)</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="va">years</span><span class="op">)</span> <span class="kw">for</span> <span class="op">(</span><span class="va">a</span> <span class="kw">in</span> <span class="va">ages</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">ldist_f_surv</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">==</span> <span class="va">y</span> <span class="op">&amp;</span> <span class="va">step</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">length</span>, <span class="va">number</span><span class="op">)</span>, main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"year = %d, age = %s"</span>, <span class="va">y</span>, <span class="va">a</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction-single-stock_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="fleet-definition">Fleet definition<a class="anchor" aria-label="anchor" href="#fleet-definition"></a>
</h4>
<p>A fleet, <code>f_surv</code>, is defined in much the same way as our
stock above, however with a different set of actions:</p>
<div class="modelScript">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create fleet definition for f_surv ####################</span></span>
<span><span class="va">f_surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_fleet</a></span><span class="op">(</span><span class="st">"f_surv"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/stock_areas.html">g3s_livesonareas</a></span><span class="op">(</span><span class="va">area_names</span><span class="op">[</span><span class="st">"IXa"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We define the stock with <code><a href="../reference/stock.html">g3_fleet()</a></code> instead of
<code><a href="../reference/stock.html">g3_stock()</a></code>, as a fleet isn’t divided into length or age
bins. Simiarly, <code><a href="../reference/stock_age.html">g3s_age()</a></code> to divide into age bins isn’t
relevant.</p>
<div class="modelScript">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">actions_f_surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/action_predate.html">g3a_predate_fleet</a></span><span class="op">(</span></span>
<span>    <span class="va">f_surv</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>    suitabilities <span class="op">=</span> <span class="fu"><a href="../reference/suitability.html">g3_suitability_exponentiall50</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    catchability_f <span class="op">=</span> <span class="fu"><a href="../reference/action_predate.html">g3a_predate_catchability_totalfleet</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/timedata.html">g3_timeareadata</a></span><span class="op">(</span><span class="st">"landings_f_surv"</span>, <span class="va">landings_f_surv</span>, <span class="st">"weight"</span>, areas <span class="op">=</span> <span class="va">area_names</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="va">actions_f_surv</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The only action of <code>f_surv</code> is to predate
<code>fish</code>. We define this with <code><a href="../reference/action_predate.html">g3a_predate_fleet()</a></code>,
setting:</p>
<ul>
<li>
<em>suitabilities</em>: This defines a predator’s preference for
stocks. In this case we use <code><a href="../reference/suitability.html">g3_suitability_exponentiall50()</a></code>
a logarithmic dependence on the difference between length of individuals
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>l</mi><mn>50</mn></msub><annotation encoding="application/x-tex">l_{50}</annotation></semantics></math>,
the length of prey with a 50% probability of predation</li>
<li>
<em>catchability_f</em>: This controls a predator’s catch/effort. In
this case we use <code><a href="../reference/action_predate.html">g3a_predate_catchability_totalfleet()</a></code> to
define effort based on total biomass caught, and
<code><a href="../reference/timedata.html">g3_timeareadata()</a></code> to provide a timeseries table of landings
data generated above</li>
</ul>
<p>For other possible settings, follow the links to the function
definitions.</p>
<p>Finally we define likelihood actions using
<code><a href="../reference/likelihood_distribution.html">g3l_catchdistribution()</a></code>, to compare modelled catch against
our length &amp; age-length distribution data generated above.</p>
<div class="modelScript">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">actions_likelihood_f_surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_catchdistribution</a></span><span class="op">(</span></span>
<span>    <span class="st">"ldist_f_surv"</span>,</span>
<span>    obs_data <span class="op">=</span> <span class="va">ldist_f_surv</span>,</span>
<span>    fleets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">f_surv</span><span class="op">)</span>,</span>
<span>    stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>    function_f <span class="op">=</span> <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_distribution_sumofsquares</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    area_group <span class="op">=</span> <span class="va">area_names</span>,</span>
<span>    report <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    nll_breakdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_catchdistribution</a></span><span class="op">(</span></span>
<span>    <span class="st">"aldist_f_surv"</span>,</span>
<span>    obs_data <span class="op">=</span> <span class="va">aldist_f_surv</span>,</span>
<span>    fleets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">f_surv</span><span class="op">)</span>,</span>
<span>    stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>    function_f <span class="op">=</span> <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_distribution_sumofsquares</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    area_group <span class="op">=</span> <span class="va">area_names</span>,</span>
<span>    report <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    nll_breakdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="va">actions_likelihood_f_surv</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Note that the only difference between the 2 likelihood actions is the
structure of the inputted data. <code>aldist_f_surv</code> unlike
<code>ldist_f_surv</code> has an age column, gadget3 will detect this
and group the modelled catch accordingly. Similarly neither data.frame
has the full range of years, so comparisons will be made outside those
ranges. For more detail on what can be done here, see
<code><a href="../articles/incorporating-observation-data.html">vignette("incorporating-observation-data")</a></code>.</p>
<p><code>function_f</code> defines the method of comparison between
modelled catch &amp; observation data, once aggregation has been done.
<code><a href="../reference/likelihood_distribution.html">g3l_distribution_sumofsquares()</a></code> in this case compares the
sum of squared difference. For more options on what to use here, follow
the links to the reference.</p>
<p>To add futher fleets to your model, just repeat the same code with a
different fleet name.</p>
</div>
</div>
<div class="section level3">
<h3 id="survey-indices">Survey indices<a class="anchor" aria-label="anchor" href="#survey-indices"></a>
</h3>
<p>Measures of abudnance, such as commercial CPUE data, can be added as
observation data by adding <code><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution()</a></code>
likelihood actions:</p>
<div class="modelScript">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create abundance index for si_cpue ########################</span></span>
<span></span>
<span><span class="co"># Generate random data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">1994</span>, step <span class="op">=</span> <span class="fl">3</span>, area <span class="op">=</span> <span class="st">'IXa'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Fill in a weight column with total biomass for the year/step/area combination</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">10000</span>, max <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>    <span class="va">dist_si_cpue</span></span>
<span></span>
<span><span class="va">actions_likelihood_si_cpue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution</a></span><span class="op">(</span></span>
<span>    <span class="st">"dist_si_cpue"</span>,</span>
<span>    <span class="va">dist_si_cpue</span>,</span>
<span>    </span>
<span>    stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>    function_f <span class="op">=</span> <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_log</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="cn">NULL</span>, beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    area_group <span class="op">=</span> <span class="va">area_names</span>,</span>
<span>    report <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    nll_breakdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="va">actions_likelihood_si_cpue</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We create a <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> with
<em>year</em>/<em>step</em>/<em>area</em>/<em>weight</em> columns, and
input this into a likelihood action as before with our fleet.</p>
<p>The key differences between the catch distribution above are:</p>
<ul>
<li>We are using <code><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution()</a></code> instead of
<code><a href="../reference/likelihood_distribution.html">g3l_catchdistribution()</a></code>, which compares model abundance
instead of catch from a fleet.</li>
<li>Our observation data has a <em>weight</em> column instead of
<em>number</em>. This results in us comparing total biomass, instead of
number of individuals.</li>
<li>We use <code><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_log()</a></code> to perform
linear regression to calculate likelihood score. We have fixed beta (the
slope) of the regression, only alpha will be estimated. We could reverse
this, or estimate both by setting to NULL.</li>
</ul>
</div>
<div class="section level3">
<h3 id="creating-model-functions-and-parameterization">Creating model functions and Parameterization<a class="anchor" aria-label="anchor" href="#creating-model-functions-and-parameterization"></a>
</h3>
<p>At this point, we are ready to convert our model into code:</p>
<div class="modelScript">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create model objective function ####################</span></span>
<span></span>
<span><span class="co"># Apply bounds in code - the other option would be using control = list(lower = g3_tmb_lower(params.in), ...)</span></span>
<span><span class="va">model_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_tmb.html">g3_to_tmb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">actions</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_report.html">g3a_report_detail</a></span><span class="op">(</span><span class="va">actions</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/likelihood_bounds.html">g3l_bounds_penalty</a></span><span class="op">(</span><span class="va">actions</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p><code><a href="../reference/run_tmb.html">g3_to_tmb()</a></code> will take our list of actions and convert it
into C++ code suitable for use with TMB.</p>
<p><code><a href="../reference/action_report.html">g3a_report_detail()</a></code> and
<code><a href="../reference/likelihood_bounds.html">g3l_bounds_penalty()</a></code> add further actions to the model,
based on the actions already within it:</p>
<ul>
<li>
<code><a href="../reference/action_report.html">g3a_report_detail()</a></code>: Adds abundance / catch reporting
suitable for use with <code>gadgetutils::g3_fit()</code> and
<code>gadgetplots::gadget_plots()</code>
</li>
<li>
<code><a href="../reference/likelihood_bounds.html">g3l_bounds_penalty()</a></code>: Adds a large likelihood penalty
for any parameter straying outside the lower/upper bounds. This allows
us to use the lower/upper bounds for parameters with optimising methods
that don’t support them natively.</li>
</ul>
<p>To be able to run this model, we need to provide values (or initial
guesses) for parameters. Earlier we used <code><a href="../reference/run_r.html">g3_to_r()</a></code> and saw
the resultant parameter template. With <code><a href="../reference/run_tmb.html">g3_to_tmb()</a></code> we can
do the same, however the template is more complex:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simple_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_tmb.html">g3_to_tmb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1991</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/action_naturalmortality.html">g3a_naturalmortality</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simple_code</span>, <span class="st">'parameter_template'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                      switch type value optimise random lower upper parscale</span></span>
<span><span class="co">## retro_years     retro_years          0    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.1           fish.M.1          0     TRUE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.2           fish.M.2          0     TRUE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.3           fish.M.3          0     TRUE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.4           fish.M.4          0     TRUE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.5           fish.M.5          0     TRUE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## project_years project_years          0    FALSE  FALSE    NA    NA       NA</span></span></code></pre>
<p>The TMB parameter template has the following columns:</p>
<ul>
<li>
<em>switch</em>: The parameter name</li>
<li>
<em>type</em>: Is the parameter a vector? Currently unused</li>
<li>
<em>value</em>: The initial value for this parameter</li>
<li>
<em>optimise</em>: Should this parameter be optimised or fixed</li>
<li>
<em>random</em>: Should random effects be applied to this parameter?
See <code><a href="../articles/random-effects.html">vignette('random-effects')</a></code>
</li>
<li>
<em>lower</em>: A lower bound for this parameter</li>
<li>
<em>upper</em>: An upper bound for this parameter</li>
<li>
<em>parscale</em>: Relative scale for this parameter vs. others</li>
</ul>
<p>The model is expecting 5 parameters, <code>fish.M.1</code> to
<code>fish.M.5</code>, for each age group. We can either fix these to
known values, or configure bounds to optimise within.</p>
<p>Filling in individual values can be tedious. The helper,
<code><a href="../reference/init_val.html">g3_init_val()</a></code>, will assist in filling in these values for
you. Instead of setting individual values we can assign values using
wildcard characters <code>*</code>, <code>#</code> (numeric),
<code>|</code> (or):</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simple_code</span>, <span class="st">"parameter_template"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.#"</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.3"</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.2|4"</span>, <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                      switch type value optimise random lower upper parscale</span></span>
<span><span class="co">## retro_years     retro_years          0    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.1           fish.M.1        0.1    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.2           fish.M.2        0.2    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.3           fish.M.3        0.5    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.4           fish.M.4        0.2    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.5           fish.M.5        0.1    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## project_years project_years          0    FALSE  FALSE    NA    NA       NA</span></span></code></pre>
<p>Setting lower &amp; upper bounds automatically turns on optimise, and
fills in parscale:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simple_code</span>, <span class="st">"parameter_template"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.#"</span>, <span class="fl">0.15</span>, lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                      switch type value optimise random lower upper parscale</span></span>
<span><span class="co">## retro_years     retro_years          0    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.1           fish.M.1       0.15     TRUE  FALSE 0.001     1    0.999</span></span>
<span><span class="co">## fish.M.2           fish.M.2       0.15     TRUE  FALSE 0.001     1    0.999</span></span>
<span><span class="co">## fish.M.3           fish.M.3       0.15     TRUE  FALSE 0.001     1    0.999</span></span>
<span><span class="co">## fish.M.4           fish.M.4       0.15     TRUE  FALSE 0.001     1    0.999</span></span>
<span><span class="co">## fish.M.5           fish.M.5       0.15     TRUE  FALSE 0.001     1    0.999</span></span>
<span><span class="co">## project_years project_years          0    FALSE  FALSE    NA    NA       NA</span></span></code></pre>
<p>We can also use spread as a shorthand for
<code>lower = value * (1 - spread), upper = value * (1 + spread)</code>:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simple_code</span>, <span class="st">"parameter_template"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.#"</span>, <span class="fl">0.15</span>, spread <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                      switch type value optimise random lower upper parscale</span></span>
<span><span class="co">## retro_years     retro_years          0    FALSE  FALSE    NA    NA       NA</span></span>
<span><span class="co">## fish.M.1           fish.M.1       0.15     TRUE  FALSE 0.075 0.225     0.15</span></span>
<span><span class="co">## fish.M.2           fish.M.2       0.15     TRUE  FALSE 0.075 0.225     0.15</span></span>
<span><span class="co">## fish.M.3           fish.M.3       0.15     TRUE  FALSE 0.075 0.225     0.15</span></span>
<span><span class="co">## fish.M.4           fish.M.4       0.15     TRUE  FALSE 0.075 0.225     0.15</span></span>
<span><span class="co">## fish.M.5           fish.M.5       0.15     TRUE  FALSE 0.075 0.225     0.15</span></span>
<span><span class="co">## project_years project_years          0    FALSE  FALSE    NA    NA       NA</span></span></code></pre>
<p>This allows us to fill in parameters without worrying too much about
stock/fleet naming:</p>
<div class="modelScript">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Guess l50 / linf based on stock sizes</span></span>
<span><span class="va">estimate_l50</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"midlen"</span><span class="op">)</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"midlen"</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">estimate_linf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"midlen"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">estimate_t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock_def</a></span><span class="op">(</span><span class="va">fish</span>, <span class="st">"minage"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.8</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">model_code</span>, <span class="st">"parameter_template"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># fish.init.scalar &amp; fish.rec.scalar: Overall scalar for recruitment/initial conditions, see g3a_renewal_normalparam()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.rec|init.scalar"</span>, <span class="fl">10</span>, lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># fish.rec.(age): Per-age recriutment scalar, see g3a_renewal_normalparam()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.init.#"</span>, <span class="fl">10</span>, lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># fish.rec.(year): Recruitment level year-on-year, see g3a_renewal_normalparam()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.rec.#"</span>, <span class="fl">100</span>, lower <span class="op">=</span> <span class="fl">1e-6</span>, upper <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># fish.rec.sd: Standard deviation for recruitment, see g3a_renewal_normalparam()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.rec.sd"</span>, <span class="fl">5</span>, lower <span class="op">=</span> <span class="fl">4</span>, upper <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># init.F: Offset for initial M, see g3a_renewal_initabund()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"init.F"</span>, <span class="fl">0.5</span>, lower <span class="op">=</span> <span class="fl">0.1</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># fish.M.(age): per-age M for our species, see g3a_naturalmortality()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.M.#"</span>, <span class="fl">0.15</span>, lower <span class="op">=</span> <span class="fl">0.001</span>, upper <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># fish.Linf, fish.K, fish.t0: VonB parameters for our species, see g3a_renewal_vonb_t0(), g3a_grow_lengthvbsimple()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.Linf"</span>, <span class="va">estimate_linf</span>, spread <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.K"</span>, <span class="fl">0.3</span>, lower <span class="op">=</span> <span class="fl">0.04</span>, upper <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.t0"</span>, <span class="va">estimate_t0</span>, spread <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># fish.walpha, fish.wbeta: Age/weight relationship for initialconditions, renewal, see g3a_renewal_normalparam()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.walpha"</span>, <span class="fl">0.01</span>, optimise <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.wbeta"</span>, <span class="fl">3</span>, optimise <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># fish.f_surv.alpha, fish.f_surv.l50: Curve/l50 for fishing suitability, see g3_suitability_exponentiall50()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.*.alpha"</span>, <span class="fl">0.07</span>, lower <span class="op">=</span> <span class="fl">0.01</span>, upper <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.*.l50"</span>, <span class="va">estimate_l50</span>, spread <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># fish.bbin: Beta for beta-binomial distribution for fish growth, see g3a_grow_impl_bbinom()</span></span>
<span>  <span class="fu"><a href="../reference/init_val.html">g3_init_val</a></span><span class="op">(</span><span class="st">"*.bbin"</span>, <span class="fl">100</span>, lower <span class="op">=</span> <span class="fl">1e-05</span>, upper <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span></span>
<span>  <span class="co"># identity() is a do-nothing function, but it lets us finish on a new line</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/identity.html" class="external-link">identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">params.in</span></span></code></pre></div>
</div>
<p>Finally we are ready for optimisation runs.
<code><a href="../reference/run_tmb.html">g3_tmb_adfun()</a></code> is a wrapper around
<code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun()</a></code> and <code><a href="https://rdrr.io/pkg/TMB/man/compile.html" class="external-link">TMB::compile</a></code>, producing a
TMB <em>objective function</em>.
<code>gadgetutils::g3_iterative()</code> then optimises based on
iterative reweighting</p>
<div class="modelScript">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Optimise model ################################</span></span>
<span><span class="va">obj.fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_tmb.html">g3_tmb_adfun</a></span><span class="op">(</span><span class="va">model_code</span>, <span class="va">params.in</span><span class="op">)</span></span>
<span></span>
<span><span class="va">params.out</span> <span class="op">&lt;-</span> <span class="fu">gadgetutils</span><span class="fu">::</span><span class="fu">g3_iterative</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    wgts <span class="op">=</span> <span class="st">"WGTS"</span>,</span>
<span>    model <span class="op">=</span> <span class="va">model_code</span>,</span>
<span>    params.in <span class="op">=</span> <span class="va">params.in</span>,</span>
<span>    grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        fleet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ldist_f_surv"</span>, <span class="st">"aldist_f_surv"</span><span class="op">)</span>,</span>
<span>        abund <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dist_si_cpue"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"BFGS"</span>,</span>
<span>    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit <span class="op">=</span> <span class="fl">1000</span>, reltol <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span>,</span>
<span>    cv_floor <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Once this has finished, we can view the output using
<code>gadgetplots::gadget_plots()</code>.</p>
<div class="modelScript">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate detailed report ######################</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">gadgetutils</span><span class="fu">::</span><span class="fu">g3_fit</span><span class="op">(</span><span class="va">model_code</span>, <span class="va">params.out</span><span class="op">)</span></span>
<span><span class="fu">gadgetplots</span><span class="fu">::</span><span class="fu">gadget_plots</span><span class="op">(</span><span class="va">fit</span>, <span class="st">"figs"</span>, file_type <span class="op">=</span> <span class="st">"html"</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Once finished, you can view the output in your web browser:</p>
<div class="modelScript">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html" class="external-link">browseURL</a></span><span class="op">(</span><span class="st">"figs/model_output_figures.html"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-full-model-script">Appendix: Full model script<a class="anchor" aria-label="anchor" href="#appendix-full-model-script"></a>
</h2>
<p>For convenience, here is all the sections of the model script above
joined together:</p>
<script>
document.write(
    '<div class="modelScript"><div class="sourceCode hasCopyButton"><pre class="downlit sourceCode r">' +
    Array.from(document.querySelectorAll('.modelScript pre')).map((x) => x.innerHTML).join("\n\n") +
    '</pre></div></div>');
</script>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jamie Lentin, Bjarki Thor Elvarsson, William Butler.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
