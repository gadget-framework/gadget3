<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Incorporating observation data into models • gadget3</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Incorporating observation data into models">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gadget3</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.12-1-999</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction-single-stock.html">Introduction to gadget3: A single stock model</a></li>
    <li><a class="dropdown-item" href="../articles/incorporating-observation-data.html">Incorporating observation data into models</a></li>
    <li><a class="dropdown-item" href="../articles/multiple-substocks.html">Modelling maturity &amp; sex with multiple stocks</a></li>
    <li><a class="dropdown-item" href="../articles/model-customisation.html">Model customisation</a></li>
    <li><a class="dropdown-item" href="../articles/random-effects.html">Spawning &amp; Random effects</a></li>
    <li><a class="dropdown-item" href="../articles/model-debugging.html">Debugging a gadget3 model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced</h6></li>
    <li><a class="dropdown-item" href="../articles/model-structure.html">Structure of a gadget3 model</a></li>
    <li><a class="dropdown-item" href="../articles/writing_actions.html">Writing G3 Actions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gadget-framework/gadget3/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Incorporating observation data into models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gadget-framework/gadget3/blob/master/vignettes/incorporating-observation-data.Rmd" class="external-link"><code>vignettes/incorporating-observation-data.Rmd</code></a></small>
      <div class="d-none name"><code>incorporating-observation-data.Rmd</code></div>
    </div>

    
    
<style type="text/css">
.hide {
  display: none!important;
}

/* https://bookdown.org/yihui/rmarkdown-cookbook/html-css.html */
.modelScript pre.sourceCode, .modelScript pre.sourceCode code {
  background-color: #f0f8ff !important;
}
</style>
<p>Each run of a model will generate a likelihood score, by summing the
result of any <em>likelihood actions</em> in the model together. To fit
a model to observation data, we need to add a <em>likelihood action</em>
that will compare observation data to the model.</p>
<p>To do this you either need <code><a href="../reference/likelihood_distribution.html">g3l_catchdistribution()</a></code> or
<code><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution()</a></code>. As the names suggest,
<code><a href="../reference/likelihood_distribution.html">g3l_catchdistribution()</a></code> will compare catch data of stocks
from the provided fleets, <code><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution()</a></code> will
compare total abundance of stocks. Otherwise they are identical.</p>
<p>This comparison is a 2 stage process:</p>
<ol style="list-style-type: decimal">
<li>Aggregation: The columns in the observation data are inspected, and
converted into an array. Model data is then aggregated into an
identically-sized array ready for the next step</li>
<li>Comparison: A comparison function (<code>function_f</code>) is
supplied to <code>g3l_*distribution()</code>, to convert to a likelihood
score. For example <code><a href="../reference/likelihood_distribution.html">g3l_distribution_sumofsquares()</a></code>, which
compares the relative abundance of each grouping vs. the model, and sums
the square of these</li>
</ol>
<p>We saw the following example in
<code><a href="../articles/introduction-single-stock.html">vignette("introduction-single-stock")</a></code>:</p>
<div class="modelScript">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># TODO: This isn't a brilliantly-named example, something else?</span></span>
<span><span class="co"># Generate random data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1990</span><span class="op">:</span><span class="fl">1994</span>, step <span class="op">=</span> <span class="fl">3</span>, area <span class="op">=</span> <span class="st">'IXa'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Fill in a number column with total numbers in that year/step/area combination</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>, min <span class="op">=</span> <span class="fl">10000</span>, max <span class="op">=</span> <span class="fl">100000</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span></span>
<span>    <span class="va">dist_si_acoustic</span></span>
<span></span>
<span><span class="va">actions_likelihood_si_acoustic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution</a></span><span class="op">(</span></span>
<span>    <span class="st">"dist_si_acoustic"</span>,</span>
<span>    obs_data <span class="op">=</span> <span class="va">dist_si_acoustic</span>,</span>
<span>    </span>
<span>    stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">fish</span><span class="op">)</span>,</span>
<span>    function_f <span class="op">=</span> <span class="fu"><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_log</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="cn">NULL</span>, beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    area_group <span class="op">=</span> <span class="va">area_names</span>,</span>
<span>    report <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    nll_breakdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The first step generates random observation data. We have the
following columns:</p>
<ul>
<li>
<em>year</em>: We want to do comparisons in 5 years, 1990..1994.
Other years nothing will happen.</li>
<li>
<em>step</em>: We compare abundance in the autumn step</li>
<li>
<em>area</em>: We only compare with stock within the ‘IXa’ area</li>
<li>
<em>number</em>: We compare against number individuals.</li>
</ul>
<p>There are no <em>age</em> or <em>length</em> columns, so this is
total abundance within that area/time.</p>
<p>We use <code><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_log()</a></code>, which
calculates the likelihood score by performing a linear fit using the log
scale, the slope (<em>beta</em>) is fixed.</p>
<p>The model optimisation process will minimise the total likelihood
score, and in the process fit the model to the observation data.</p>
<div class="section level2">
<h2 id="gadget2-gadget3-translation">gadget2&lt;-&gt;gadget3 translation<a class="anchor" aria-label="anchor" href="#gadget2-gadget3-translation"></a>
</h2>
<p>The function of many of gadget2’s likeihood components has been
collapsed down into these 2 functions. Here is a summary of how to
translate:</p>
<ul>
<li>
<a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html#sec-catchdist" class="external-link">CatchDistribution</a>
likelihood component
<ul>
<li>Use <code><a href="../reference/likelihood_distribution.html">g3l_catchdistribution()</a></code>
</li>
<li>Set <em>function_f</em> parameter to the matching
<code>g3l_distribution_*()</code> function,
e.g. <code><a href="../reference/likelihood_distribution.html">g3l_distribution_sumofsquares()</a></code>
</li>
<li>Supply data with columns <em>year</em>, <em>step</em>,
<em>area</em>, <em>age</em>, <em>length</em>, <em>number</em>
</li>
</ul>
</li>
<li>
<a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html#sec-surveyindices" class="external-link">SurveyIndices</a>
likelihood component
<ul>
<li>Use <code><a href="../reference/likelihood_distribution.html">g3l_abundancedistribution()</a></code>
</li>
<li>Set <em>function_f</em> parameter to
<code><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_log()</a></code> or
<code><a href="../reference/likelihood_distribution.html">g3l_distribution_surveyindices_linear()</a></code>
</li>
<li>Supply data with columns <em>year</em>, <em>step</em>,
<em>area</em>, <em>length</em>, <em>number</em>
</li>
</ul>
</li>
<li>
<a href="https://gadget-framework.github.io/gadget2/userguide/chap-like.html#sec-catchinkilos" class="external-link">CatchInKilos</a>
likelihood component
<ul>
<li>Use
<code>g3l_catchdistribution(function_f = g3l_distribution_sumofsquares())</code>
</li>
<li>Supply data with columns <em>year</em>, <em>step</em>,
<em>area</em>, <em>fleet</em>, <em>weight</em>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="observation-data-format">Observation data format<a class="anchor" aria-label="anchor" href="#observation-data-format"></a>
</h2>
<p>gadget3 bases it’s decision on how to aggregate on the incoming data.
Whilst it tries to do the “right thing” in most cases, it’s important to
get the shape of this data to match what you require.</p>
<p>In doing so, the incoming <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> is converted into
an <code><a href="https://rdrr.io/r/base/array.html" class="external-link">array()</a></code>. We can use the
<code><a href="../reference/likelihood_distribution.html">g3_distribution_preview()</a></code> function to see what that array
will look like, and in doing so see how gadget3 will treat the
observation data.</p>
<p>Critically, your data needs to have column names it recognises. The
following breaks down what can be by each column.</p>
<div class="section level3">
<h3 id="weight-and-number-columns">
<em>weight</em> and <em>number</em> columns<a class="anchor" aria-label="anchor" href="#weight-and-number-columns"></a>
</h3>
<p>At least a <em>weight</em> or <em>number</em> column needs to be
supplied. If a <em>number</em> column is present then each value will be
compared to number of individuals in that group. If a <em>weight</em>
column is present then each value will be compared to total biomass in
that group.</p>
<p>The <em>weight</em> is suitable for total catches in kilos, otherwise
the <em>number</em> column will generally be used.</p>
</div>
<div class="section level3">
<h3 id="year-and-step-columns-landings-abundance-indices">
<em>year</em> and <em>step</em> columns: Landings, abundance
indices<a class="anchor" aria-label="anchor" href="#year-and-step-columns-landings-abundance-indices"></a>
</h3>
<p>If a <em>year</em> column is given, then catch/abundance will be
aggregated by year. Gaps are allowed, if so then no comparisons will be
made for that year/step.</p>
<p>The following observations will be compared against the total number
of indivduals caught in years 1999, 2000, 2002, 2003:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year  number</span></span>
<span><span class="st">1999    1000</span></span>
<span><span class="st">2000    1002</span></span>
<span><span class="st">2002    1004</span></span>
<span><span class="st">2003    1008</span></span>
<span><span class="st">"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        time</span></span>
<span><span class="co">## length  1999 2000 2002 2003</span></span>
<span><span class="co">##   0:Inf 1000 1002 1004 1008</span></span></code></pre>
<p>If <em>step</em> is given, then it will restrict it to that step
within the year (see <code><a href="../reference/action_time.html">?g3a_time</a></code> for how to define steps in a
year).</p>
<p>In the following example, we will aggregate <strong>spring</strong>
of 1999 &amp; 2000, <strong>autumn</strong> of 2001. Any catch in spring
of 2001, or other periods not mentioned, will be ignored:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year step number</span></span>
<span><span class="st">1999    2   1020</span></span>
<span><span class="st">2000    2   2040</span></span>
<span><span class="st">2001    3   1902</span></span>
<span><span class="st">"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        time</span></span>
<span><span class="co">## length  1999-02 2000-02 2001-03</span></span>
<span><span class="co">##   0:Inf    1020    2040    1902</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="length-column-length-distribution-data">
<em>length</em> column: Length distribution data<a class="anchor" aria-label="anchor" href="#length-column-length-distribution-data"></a>
</h3>
<p>Adding a length column will aggregate catch/abundance data by the
same length bins as in the observation data.</p>
<p>For instance:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year  length number</span></span>
<span><span class="st">1999  [0,10)  1023</span></span>
<span><span class="st">1999 [10,20)  2938</span></span>
<span><span class="st">1999 [20,30)  3948</span></span>
<span><span class="st">1999 [30,40)  3855</span></span>
<span><span class="st">2000  [0,10)  1023</span></span>
<span><span class="st">2000 [10,20)  2938</span></span>
<span><span class="st"># NB: No [10,30)</span></span>
<span><span class="st">2000 [30,40)  3855</span></span>
<span><span class="st">"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        time</span></span>
<span><span class="co">## length  1999 2000</span></span>
<span><span class="co">##   0:10  1023 1023</span></span>
<span><span class="co">##   10:20 2938 2938</span></span>
<span><span class="co">##   20:30 3948   NA</span></span>
<span><span class="co">##   30:40 3855 3855</span></span></code></pre>
<p>Note that unlike with the <em>year</em> &amp; <em>step</em> columns,
here gaps in data are preserved, in the preview output we see
<code>NA</code> for the missing <em>year</em> &amp; <em>length</em>
combination. By default we will compare to <code>0</code> at this point,
this behaviour is controlled with the <em>missing_val</em> parameter to
<code><a href="../reference/likelihood_distribution.html">?g3l_catchdistribution</a></code>.</p>
<p>Length aggregations do not have to be hand-crafted like we do above,
a length column could be generated using <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">dplyr::group_by()</a></code>
and <code><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate an unaggregated length distribution</span></span>
<span><span class="va">ldist.lln.raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1999</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>    length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">75</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    number <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Group length into 10-long bins</span></span>
<span><span class="va">ldist.lln.raw</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="va">year</span>,</span>
<span>  length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">length</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">'keep'</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ldist.lln.agg</span></span>
<span><span class="va">ldist.lln.agg</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 14 × 3</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   year, length [14]</span></span></span>
<span><span class="co">##     year length  number</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>  <span style="text-decoration: underline;">1</span>999 [10,20)     11</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>  <span style="text-decoration: underline;">1</span>999 [20,30)      5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>  <span style="text-decoration: underline;">1</span>999 [30,40)      7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>  <span style="text-decoration: underline;">1</span>999 [40,50)     11</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>  <span style="text-decoration: underline;">1</span>999 [50,60)      8</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>  <span style="text-decoration: underline;">1</span>999 [60,70)      7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>  <span style="text-decoration: underline;">1</span>999 [70,80)      1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>  <span style="text-decoration: underline;">2</span>000 [10,20)      3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>  <span style="text-decoration: underline;">2</span>000 [20,30)      6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>  <span style="text-decoration: underline;">2</span>000 [30,40)     14</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span>  <span style="text-decoration: underline;">2</span>000 [40,50)     10</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span>  <span style="text-decoration: underline;">2</span>000 [50,60)      9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span>  <span style="text-decoration: underline;">2</span>000 [60,70)      6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span>  <span style="text-decoration: underline;">2</span>000 [70,80)      2</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NB: The last 2 bins are empty, but because cut() creates a factor column,</span></span>
<span><span class="co">#     gadget3 knows about them even though they don't appear in the data.</span></span>
<span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="va">ldist.lln.agg</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         time</span></span>
<span><span class="co">## length   1999 2000</span></span>
<span><span class="co">##   10:20    11    3</span></span>
<span><span class="co">##   20:30     5    6</span></span>
<span><span class="co">##   30:40     7   14</span></span>
<span><span class="co">##   40:50    11   10</span></span>
<span><span class="co">##   50:60     8    9</span></span>
<span><span class="co">##   60:70     7    6</span></span>
<span><span class="co">##   70:80     1    2</span></span>
<span><span class="co">##   80:90    NA   NA</span></span>
<span><span class="co">##   90:100   NA   NA</span></span></code></pre>
<p>gadget3 will also automatically read the aggregation attributes used
by <code><a href="https://rdrr.io/pkg/mfdb/man/mfdb_queries.html" class="external-link">?mfdb::mfdb_sample_count</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import data into a temporary database</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mfdb</span><span class="op">)</span></span>
<span><span class="va">mdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb.html" class="external-link">mfdb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext<span class="op">=</span><span class="st">".duckdb"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ldist.lln.raw</span><span class="op">$</span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">ldist.lln.raw</span><span class="op">$</span><span class="va">areacell</span> <span class="op">&lt;-</span> <span class="st">'all'</span>  <span class="co"># NB: We have to have an areacell mapping for MFDB</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb_import_taxonomy.html" class="external-link">mfdb_import_area</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'all'</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb_import_data.html" class="external-link">mfdb_import_survey</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="va">ldist.lln.raw</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use mfdb_sample_count to extract &amp; group in the same manner as above</span></span>
<span><span class="va">ldist.lln.agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb_queries.html" class="external-link">mfdb_sample_count</a></span><span class="op">(</span><span class="va">mdb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'length'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    year<span class="op">=</span><span class="fl">1999</span><span class="op">:</span><span class="fl">2000</span>,</span>
<span>    length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb_aggregate_interval.html" class="external-link">mfdb_interval</a></span><span class="op">(</span><span class="st">"len"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="va">ldist.lln.agg</span>, area_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>all<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/mfdb/man/mfdb.html" class="external-link">mfdb_disconnect</a></span><span class="op">(</span><span class="va">mdb</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="age-column-age-length-distribution-data">
<em>age</em> column: Age-Length distribution data<a class="anchor" aria-label="anchor" href="#age-column-age-length-distribution-data"></a>
</h3>
<p>Age-length aggregations can be performed by adding an <em>age</em>
column in a very similar manner to the <em>length</em> column:</p>
<p>We can both group by individual age values:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year  age  length number</span></span>
<span><span class="st">1999    1  [0,10)  1026</span></span>
<span><span class="st">1999    1 [10,20)  2936</span></span>
<span><span class="st">1999    1 [20,30)  3962</span></span>
<span><span class="st">1999    1 [30,40)  3863</span></span>
<span><span class="st">1999    2  [0,10)  1026</span></span>
<span><span class="st">1999    2 [10,20)  2936</span></span>
<span><span class="st">1999    2 [20,30)  3962</span></span>
<span><span class="st">1999    2 [30,40)  3863</span></span>
<span><span class="st">"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## , , time = 1999</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##        age</span></span>
<span><span class="co">## length  age1 age2</span></span>
<span><span class="co">##   0:10  1026 1026</span></span>
<span><span class="co">##   10:20 2936 2936</span></span>
<span><span class="co">##   20:30 3962 3962</span></span>
<span><span class="co">##   30:40 3863 3863</span></span></code></pre>
<p>…or group ages together:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year  age    length number</span></span>
<span><span class="st">1999  [1,1]    [0,10)  1026</span></span>
<span><span class="st">1999  [1,1]   [10,20)  2936</span></span>
<span><span class="st">1999  [1,1]   [20,30)  3962</span></span>
<span><span class="st">1999  [1,1]   [30,40)  3863</span></span>
<span><span class="st">1999  [2,4]  [0,10)  1011</span></span>
<span><span class="st"># Missing [2,4] [10,20)</span></span>
<span><span class="st">1999  [2,4] [20,30)  3946</span></span>
<span><span class="st">1999  [2,4] [30,40)  3872</span></span>
<span><span class="st">"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## , , time = 1999</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##        age</span></span>
<span><span class="co">## length   1:1  2:4</span></span>
<span><span class="co">##   0:10  1026 1011</span></span>
<span><span class="co">##   10:20 2936   NA</span></span>
<span><span class="co">##   20:30 3962 3946</span></span>
<span><span class="co">##   30:40 3863 3872</span></span></code></pre>
<p>As before, gaps in data are preserved, and <code>missing_val</code>
is used to decide what to do with them.</p>
<p>Again, gadget3 will also interpret aggregation generated by
<code>group_by(age = cut(...))</code> or
<code><a href="https://rdrr.io/pkg/mfdb/man/mfdb_queries.html" class="external-link">?mfdb::mfdb_sample_count</a></code>.</p>
</div>
<div class="section level3">
<h3 id="area-column">
<em>area</em> column<a class="anchor" aria-label="anchor" href="#area-column"></a>
</h3>
<p>If a stock is divided up into multiple areas, then data can be broken
down by area</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">area_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock_areas.html">g3_areas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'IXa'</span>, <span class="st">'IXb'</span>, <span class="st">'IXc'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year    area    number</span></span>
<span><span class="st">1999   IXa   1000</span></span>
<span><span class="st">1999   IXb   4305</span></span>
<span><span class="st">2000   IXa   7034</span></span>
<span><span class="st">2000   IXb   2381</span></span>
<span><span class="st">2001   IXb   3913</span></span>
<span><span class="st">"</span><span class="op">)</span>, area_group <span class="op">=</span> <span class="va">area_names</span><span class="op">)</span><span class="op">[</span>length <span class="op">=</span> <span class="st">'0:Inf'</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##       area</span></span>
<span><span class="co">## time    IXa  IXb</span></span>
<span><span class="co">##   1999 1000 4305</span></span>
<span><span class="co">##   2000 7034 2381</span></span>
<span><span class="co">##   2001   NA 3913</span></span></code></pre>
<p>As before, gaps in data are preserved, and <code>missing_val</code>
is used to decide what to do with them.</p>
<p>However, if an area isn’t mentioned at all (note that
<code>IXc</code> does not figure in the above data), then it won’t be
compared.</p>
</div>
<div class="section level3">
<h3 id="stock-column-maturity-stage-distribution">
<em>stock</em> column: Maturity stage distribution<a class="anchor" aria-label="anchor" href="#stock-column-maturity-stage-distribution"></a>
</h3>
<p>If you have multiple stocks, for example because you have divided up
your species into mature and immature substocks, you can use this
division in likelihood components also:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">'fish'</span>, <span class="st">'imm'</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">st_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">'fish'</span>, <span class="st">'mat'</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year    stock    number</span></span>
<span><span class="st">1999   fish_imm   1000</span></span>
<span><span class="st">1999   fish_mat   4305</span></span>
<span><span class="st">2000   fish_imm   7034</span></span>
<span><span class="st">2000   fish_mat   2381</span></span>
<span><span class="st">2001   fish_mat   3913</span></span>
<span><span class="st">"</span><span class="op">)</span>, stocks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">st_imm</span>, <span class="va">st_mat</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>length <span class="op">=</span> <span class="st">'0:Inf'</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##           time</span></span>
<span><span class="co">## stock      1999 2000 2001</span></span>
<span><span class="co">##   fish_imm 1000 7034   NA</span></span>
<span><span class="co">##   fish_mat 4305 2381 3913</span></span></code></pre>
<p>The stock names have to match what gadget3 uses, or an error will be
generated.</p>
<p>As before, gaps in data are preserved, and <code>missing_val</code>
is used to decide what to do with them.</p>
</div>
<div class="section level3">
<h3 id="fleet-column">
<em>fleet</em> column<a class="anchor" aria-label="anchor" href="#fleet-column"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_comm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_fleet</a></span><span class="op">(</span><span class="st">'comm'</span><span class="op">)</span></span>
<span><span class="va">f_surv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_fleet</a></span><span class="op">(</span><span class="st">'surv'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/likelihood_distribution.html">g3_distribution_preview</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span>header <span class="op">=</span> <span class="cn">TRUE</span>, text<span class="op">=</span><span class="st">"</span></span>
<span><span class="st">year    fleet    number</span></span>
<span><span class="st">1999   f_comm   1000</span></span>
<span><span class="st">1999   f_surv   4305</span></span>
<span><span class="st">2000   f_comm   7034</span></span>
<span><span class="st">2000   f_surv   2381</span></span>
<span><span class="st">2001   f_surv   3913</span></span>
<span><span class="st">"</span><span class="op">)</span>, fleets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">f_comm</span>, <span class="va">f_surv</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>length <span class="op">=</span> <span class="st">'0:Inf'</span>,,<span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##         time</span></span>
<span><span class="co">## fleet    1999 2000 2001</span></span>
<span><span class="co">##   f_comm 1000 7034   NA</span></span>
<span><span class="co">##   f_surv 4305 2381 3913</span></span></code></pre>
<p>The stock names have to match what gadget3 uses, or an error will be
generated.</p>
<p>As before, gaps in data are preserved, and <code>missing_val</code>
is used to decide what to do with them.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jamie Lentin, Bjarki Thor Elvarsson, William Butler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
