<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Structure of a gadget3 model • gadget3</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Structure of a gadget3 model">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.12-1-999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction-single-stock.html">Introduction to gadget3: A single stock model</a>
    </li>
    <li>
      <a href="../articles/incorporating-observation-data.html">Incorporating observation data into models</a>
    </li>
    <li>
      <a href="../articles/multiple-substocks.html">Modelling maturity &amp; sex with multiple stocks</a>
    </li>
    <li>
      <a href="../articles/model-customisation.html">Model customisation</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Spawning &amp; Random effects</a>
    </li>
    <li>
      <a href="../articles/model-debugging.html">Debugging a gadget3 model</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/model-structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/writing_actions.html">Writing G3 Actions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/gadget-framework/gadget3/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Structure of a gadget3 model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gadget-framework/gadget3/blob/master/vignettes/model-structure.Rmd" class="external-link"><code>vignettes/model-structure.Rmd</code></a></small>
      <div class="hidden name"><code>model-structure.Rmd</code></div>

    </div>

    
    
<p>The following describes the structure of a gadget3 model, from the
bottom up.</p>
<div class="section level2">
<h2 id="r-formula-or-the-tilde-operator">R formula, or the tilde operator<a class="anchor" aria-label="anchor" href="#r-formula-or-the-tilde-operator"></a>
</h2>
<p>Crucial to gadget3 is the <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/formula.html" class="external-link">R
formula</a>, created using the tilde operator (<code>~</code>). These
get used in several places in R for various things, but at their core
the tilde operator stores the R code on the left and right hand sides,
as well as the environment it was created in, which amounts to all
variables defined at the time.</p>
<p>For example, let’s declare a function that produces a formula, and
make some:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_formula</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">size</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># NB: The reason we make a function here is so we have an isolated environment</span></span>
<span>    <span class="co"># to make examples cleaner.</span></span>
<span>    <span class="va">cows</span> <span class="op">&lt;-</span> <span class="va">size</span> <span class="op">*</span> <span class="fl">2</span></span>
<span>    <span class="va">pigs</span> <span class="op">&lt;-</span> <span class="va">size</span> <span class="op">*</span> <span class="fl">4</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">~</span><span class="va">cows</span> <span class="op">+</span> <span class="va">pigs</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">get_formula</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">get_formula</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> shows <code>f</code> contains the formula’s code
(not the result of cows + pigs), and has an environment attached:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Class 'formula'  language ~cows + pigs</span></span>
<span><span class="co">##   ..- attr(*, ".Environment")=&lt;environment: 0x55ed673573b0&gt;</span></span></code></pre>
<p>We can look into this environment, and see the values that got set
for cows &amp; pigs:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 3</span></span>
<span><span class="co">##  $ pigs: num 32</span></span>
<span><span class="co">##  $ cows: num 16</span></span>
<span><span class="co">##  $ size: num 8</span></span></code></pre>
<p>We can do similarly for <code>g</code>, and see the results are
different:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 3</span></span>
<span><span class="co">##  $ pigs: num 20</span></span>
<span><span class="co">##  $ cows: num 10</span></span>
<span><span class="co">##  $ size: num 5</span></span></code></pre>
<p>Note that:</p>
<ul>
<li>R hasn’t at any point worked out <code>cows + pigs</code>, the code
was stored for later use.</li>
<li>The environment (i.e. all variables defined at that point) is
“remembered”</li>
</ul>
<p>A g3 model at it’s core is a list of formula objects that make up the
model. We can even use Gadget3 to compile our simple example above into
an R function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## function (param = attr(get(sys.call()[[1]]), "parameter_template")) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     cows &lt;- 16</span></span>
<span><span class="co">##     pigs &lt;- 32</span></span>
<span><span class="co">##     while (TRUE) {</span></span>
<span><span class="co">##         cows + pigs</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55ed68974fc8&gt;</span></span>
<span><span class="co">## &lt;environment: 0x55ed6817f520&gt;</span></span></code></pre>
<p>…or a TMB template:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_tmb.html">g3_to_tmb</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## #include &lt;TMB.hpp&gt;</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## template&lt;class Type&gt;</span></span>
<span><span class="co">## Type objective_function&lt;Type&gt;::operator() () {</span></span>
<span><span class="co">##     DATA_SCALAR(reporting_enabled); DATA_UPDATE(reporting_enabled);</span></span>
<span><span class="co">##     Type cows = (double)(16);</span></span>
<span><span class="co">##     Type pigs = (double)(32);</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     while (true) {</span></span>
<span><span class="co">##         cows + pigs;</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span></code></pre>
<p>Obviously this in itself isn’t a very useful function, but you can
see that the environment for the formula has provided the initial values
for the variables, and the code itself has been put into the main
loop.</p>
<p>Also note that, despite appearances, we’re not generically converting
R into C++. There’s a subset of R that gadget3 understands and knows how
to convert. Using R libraries isn’t possible, for example. To simplify
scoping rules, we assume variables are either global, and should have
different names, or are iterators in loops, in which case they will be
local to that loop.</p>
</div>
<div class="section level2">
<h2 id="actions">Actions<a class="anchor" aria-label="anchor" href="#actions"></a>
</h2>
<p>In reality you will never be providing formulae to insert into models
directly, you’d be using the g3 action functions to generate these for
you. All action functions, prefixed with <code>g3a_</code>, produce a
list of formula objects—an action in gadget3 parlance. These are where
the gadget functionality is implemented.</p>
<p>One of the simplest is <code>g3a_time</code>, which produces code
that will count years/steps, and stop when the end of the time period is
reached. For example:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1999</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $`-01`</span></span>
<span><span class="co">## ~{</span></span>
<span><span class="co">##     debug_label("g3a_time: Start of time period")</span></span>
<span><span class="co">##     cur_time &lt;- cur_time + 1L</span></span>
<span><span class="co">##     if (cur_time == 0 &amp;&amp; assert_msg(g3_param("retro_years", value = 0, </span></span>
<span><span class="co">##         optimise = FALSE, source = "g3a_time") &gt;= 0, "retro_years must be &gt;= 0")) </span></span>
<span><span class="co">##         return(NaN)</span></span>
<span><span class="co">##     if (cur_time == 0 &amp;&amp; assert_msg(project_years &gt;= 0, "project_years must be &gt;= 0")) </span></span>
<span><span class="co">##         return(NaN)</span></span>
<span><span class="co">##     cur_year &lt;- start_year + (cur_time%/%step_count)</span></span>
<span><span class="co">##     cur_year_projection &lt;- cur_year &gt; end_year - g3_param("retro_years", </span></span>
<span><span class="co">##         value = 0, optimise = FALSE, source = "g3a_time")</span></span>
<span><span class="co">##     cur_step &lt;- (cur_time%%step_count) + 1L</span></span>
<span><span class="co">##     cur_step_size &lt;- step_lengths[[cur_step]]/12</span></span>
<span><span class="co">##     cur_step_final &lt;- cur_step == step_count</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;environment: 0x55ed618147a8&gt;</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $`001`</span></span>
<span><span class="co">## ~{</span></span>
<span><span class="co">##     if (cur_time &gt; total_steps) </span></span>
<span><span class="co">##         return(nll)</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;environment: 0x55ed68f3f858&gt;</span></span></code></pre>
<p>Like in the example above, the definitions are part of the formula’s
environment, and if we compile it we see our years ending up in the
code.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1999</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## function (param = attr(get(sys.call()[[1]]), "parameter_template")) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     stopifnot("retro_years" %in% names(param))</span></span>
<span><span class="co">##     assert_msg &lt;- function(expr, message) {</span></span>
<span><span class="co">##         if (isFALSE(expr)) {</span></span>
<span><span class="co">##             warning(message)</span></span>
<span><span class="co">##             return(TRUE)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(FALSE)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     cur_time &lt;- -1L</span></span>
<span><span class="co">##     stopifnot("project_years" %in% names(param))</span></span>
<span><span class="co">##     project_years &lt;- param[["project_years"]]</span></span>
<span><span class="co">##     cur_year &lt;- 0L</span></span>
<span><span class="co">##     start_year &lt;- 1990L</span></span>
<span><span class="co">##     step_lengths &lt;- 12L</span></span>
<span><span class="co">##     step_count &lt;- length(step_lengths)</span></span>
<span><span class="co">##     cur_year_projection &lt;- FALSE</span></span>
<span><span class="co">##     end_year &lt;- 1999L</span></span>
<span><span class="co">##     cur_step &lt;- 0L</span></span>
<span><span class="co">##     cur_step_size &lt;- step_lengths[[1]]/12</span></span>
<span><span class="co">##     cur_step_final &lt;- FALSE</span></span>
<span><span class="co">##     retro_years &lt;- param[["retro_years"]]</span></span>
<span><span class="co">##     total_steps &lt;- length(step_lengths) * (end_year - retro_years - </span></span>
<span><span class="co">##         start_year + project_years) + length(step_lengths) - </span></span>
<span><span class="co">##         1L</span></span>
<span><span class="co">##     nll &lt;- 0</span></span>
<span><span class="co">##     while (TRUE) {</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             comment("g3a_time: Start of time period")</span></span>
<span><span class="co">##             cur_time &lt;- cur_time + 1L</span></span>
<span><span class="co">##             if (cur_time == 0 &amp;&amp; assert_msg(param[["retro_years"]] &gt;= </span></span>
<span><span class="co">##                 0, "retro_years must be &gt;= 0")) </span></span>
<span><span class="co">##                 return(NaN)</span></span>
<span><span class="co">##             if (cur_time == 0 &amp;&amp; assert_msg(project_years &gt;= </span></span>
<span><span class="co">##                 0, "project_years must be &gt;= 0")) </span></span>
<span><span class="co">##                 return(NaN)</span></span>
<span><span class="co">##             cur_year &lt;- start_year + (cur_time%/%step_count)</span></span>
<span><span class="co">##             cur_year_projection &lt;- cur_year &gt; end_year - param[["retro_years"]]</span></span>
<span><span class="co">##             cur_step &lt;- (cur_time%%step_count) + 1L</span></span>
<span><span class="co">##             cur_step_size &lt;- step_lengths[[cur_step]]/12</span></span>
<span><span class="co">##             cur_step_final &lt;- cur_step == step_count</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             if (cur_time &gt; total_steps) </span></span>
<span><span class="co">##                 return(nll)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55ed663fc4f8&gt;</span></span>
<span><span class="co">## &lt;environment: 0x55ed689204c0&gt;</span></span></code></pre>
<p>In this case our years have been hard-coded, but their definitions
could themselves be formula and the end result will be added to the
model. For example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="op">~</span><span class="va">start_year</span> <span class="op">+</span> <span class="fl">4</span> <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## function (param = attr(get(sys.call()[[1]]), "parameter_template")) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     stopifnot("retro_years" %in% names(param))</span></span>
<span><span class="co">##     assert_msg &lt;- function(expr, message) {</span></span>
<span><span class="co">##         if (isFALSE(expr)) {</span></span>
<span><span class="co">##             warning(message)</span></span>
<span><span class="co">##             return(TRUE)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(FALSE)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     cur_time &lt;- -1L</span></span>
<span><span class="co">##     stopifnot("project_years" %in% names(param))</span></span>
<span><span class="co">##     project_years &lt;- param[["project_years"]]</span></span>
<span><span class="co">##     cur_year &lt;- 0L</span></span>
<span><span class="co">##     start_year &lt;- 1990L</span></span>
<span><span class="co">##     step_lengths &lt;- 12L</span></span>
<span><span class="co">##     step_count &lt;- length(step_lengths)</span></span>
<span><span class="co">##     cur_year_projection &lt;- FALSE</span></span>
<span><span class="co">##     end_year &lt;- start_year + 4</span></span>
<span><span class="co">##     cur_step &lt;- 0L</span></span>
<span><span class="co">##     cur_step_size &lt;- step_lengths[[1]]/12</span></span>
<span><span class="co">##     cur_step_final &lt;- FALSE</span></span>
<span><span class="co">##     retro_years &lt;- param[["retro_years"]]</span></span>
<span><span class="co">##     total_steps &lt;- length(step_lengths) * (end_year - retro_years - </span></span>
<span><span class="co">##         start_year + project_years) + length(step_lengths) - </span></span>
<span><span class="co">##         1L</span></span>
<span><span class="co">##     nll &lt;- 0</span></span>
<span><span class="co">##     while (TRUE) {</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             comment("g3a_time: Start of time period")</span></span>
<span><span class="co">##             cur_time &lt;- cur_time + 1L</span></span>
<span><span class="co">##             if (cur_time == 0 &amp;&amp; assert_msg(param[["retro_years"]] &gt;= </span></span>
<span><span class="co">##                 0, "retro_years must be &gt;= 0")) </span></span>
<span><span class="co">##                 return(NaN)</span></span>
<span><span class="co">##             if (cur_time == 0 &amp;&amp; assert_msg(project_years &gt;= </span></span>
<span><span class="co">##                 0, "project_years must be &gt;= 0")) </span></span>
<span><span class="co">##                 return(NaN)</span></span>
<span><span class="co">##             cur_year &lt;- start_year + (cur_time%/%step_count)</span></span>
<span><span class="co">##             cur_year_projection &lt;- cur_year &gt; end_year - param[["retro_years"]]</span></span>
<span><span class="co">##             cur_step &lt;- (cur_time%%step_count) + 1L</span></span>
<span><span class="co">##             cur_step_size &lt;- step_lengths[[cur_step]]/12</span></span>
<span><span class="co">##             cur_step_final &lt;- cur_step == step_count</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             if (cur_time &gt; total_steps) </span></span>
<span><span class="co">##                 return(nll)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55ed6896f7c0&gt;</span></span>
<span><span class="co">## &lt;environment: 0x55ed6625db18&gt;</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="stocks">Stocks<a class="anchor" aria-label="anchor" href="#stocks"></a>
</h2>
<p>Beyond <code><a href="../reference/action_time.html">g3a_time()</a></code>, pretty much any action will be
describing changes to a stock, possibly via. interacting with another
stock (or fleet). To keep track of this state, we use <em>g3_stock</em>
objects. These describe several things:</p>
<ul>
<li>The dimensions one would use if making an array to store data on
that stock. For example if we want an array for number of individuals,
what lengthgroups do we use? How many ages do we store? How many (and
which) areas do we have?</li>
<li>What code do we need to iterate over the stock? Say I want to add 1
individual to each lengthgroup, how do I loop over all the other
dimensions?</li>
<li>If looping over one stock, how do I find corresponding entries in
another stock? For example, my fleet is only interested in prey that is
in the same area.</li>
</ul>
<p>g3_stock objects can be created with either <code><a href="../reference/stock.html">g3_stock()</a></code>
or <code><a href="../reference/stock.html">g3_fleet()</a></code>, the former will store lengthgroups, which
fleets do not have.</p>
<p>Actions will store data about the stocks, for instance the current
number of individuals, in arrays called stock instances. We can see what
sort of arrays a stock will make by using
<code>g3_stock_instance</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ling_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="st">'ling_imm'</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/stock.html">g3_stock_instance</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## length</span></span>
<span><span class="co">##   0:10  10:20  20:30  30:40  40:50 50:Inf </span></span>
<span><span class="co">##     NA     NA     NA     NA     NA     NA</span></span></code></pre>
<p>To add complexity to our model, we can use other <code>g3s_</code>
functions, such as <code><a href="../reference/stock_areas.html">g3s_livesonareas()</a></code> or
<code><a href="../reference/stock_age.html">g3s_age()</a></code>, which adds area or age dimensions to a
stock:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ling_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="st">'ling_imm'</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stock_age.html">g3s_age</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/stock.html">g3_stock_instance</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         age</span></span>
<span><span class="co">## length   age3 age4 age5 age6 age7 age8 age9 age10</span></span>
<span><span class="co">##   0:10     NA   NA   NA   NA   NA   NA   NA    NA</span></span>
<span><span class="co">##   10:20    NA   NA   NA   NA   NA   NA   NA    NA</span></span>
<span><span class="co">##   20:30    NA   NA   NA   NA   NA   NA   NA    NA</span></span>
<span><span class="co">##   30:40    NA   NA   NA   NA   NA   NA   NA    NA</span></span>
<span><span class="co">##   40:50    NA   NA   NA   NA   NA   NA   NA    NA</span></span>
<span><span class="co">##   50:Inf   NA   NA   NA   NA   NA   NA   NA    NA</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ling_imm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_stock</a></span><span class="op">(</span><span class="st">'ling_imm'</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stock_areas.html">g3s_livesonareas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/stock_age.html">g3s_age</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/stock.html">g3_stock_instance</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span><span class="op">[</span>,,<span class="st">'age3'</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">##         area</span></span>
<span><span class="co">## length   area1 area2</span></span>
<span><span class="co">##   0:10      NA    NA</span></span>
<span><span class="co">##   10:20     NA    NA</span></span>
<span><span class="co">##   20:30     NA    NA</span></span>
<span><span class="co">##   30:40     NA    NA</span></span>
<span><span class="co">##   40:50     NA    NA</span></span>
<span><span class="co">##   50:Inf    NA    NA</span></span></code></pre>
<p>When you use an action such as <code><a href="../reference/action_grow.html">g3a_growmature()</a></code>, you
provide g3_stock(s) to act on, and formula objects to fill in gaps in
the code. <code><a href="../reference/action_grow.html">g3a_growmature()</a></code> will iterate over all areas/ages
the stock has, and apply growth for each length group it finds.</p>
<p><code><a href="../reference/action_grow.html">g3a_growmature()</a></code> itself doesn’t care about areas or age,
it just does the same to each. However, the formula you supply can.
<code>age</code> and <code>area</code> variables will be set with the
current age/area, which you can use when writing formula. For
example:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="../reference/action_grow.html">g3a_growmature</a></span><span class="op">(</span></span>
<span>    <span class="va">ling_imm</span>,</span>
<span>    impl_f <span class="op">=</span> <span class="fu"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span><span class="op">(</span></span>
<span>        delta_len_f <span class="op">=</span> <span class="op">~</span><span class="va">age</span> <span class="op">*</span> <span class="fl">10</span>,</span>
<span>        delta_wgt_f <span class="op">=</span> <span class="op">~</span><span class="va">area</span> <span class="op">*</span> <span class="fl">20</span>,</span>
<span>        beta_f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">"ling.bbin"</span><span class="op">)</span>,</span>
<span>        maxlengthgroupgrowth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    transition_f <span class="op">=</span> <span class="op">~</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fn</span></span></code></pre></div>
<pre><code><span><span class="co">## function (param = attr(get(sys.call()[[1]]), "parameter_template")) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     stopifnot("ling.bbin" %in% names(param))</span></span>
<span><span class="co">##     growth_bbinom &lt;- function(delt_l, binn, beta) {</span></span>
<span><span class="co">##         alpha &lt;- (beta * delt_l)/(binn - delt_l)</span></span>
<span><span class="co">##         x &lt;- 0:binn</span></span>
<span><span class="co">##         na &lt;- length(alpha)</span></span>
<span><span class="co">##         n &lt;- length(x) - 1</span></span>
<span><span class="co">##         alpha &lt;- rep(alpha, n + 1)</span></span>
<span><span class="co">##         x &lt;- rep(x, each = na)</span></span>
<span><span class="co">##         val &lt;- exp(lgamma(n + 1) + lgamma(alpha + beta) + lgamma(n - </span></span>
<span><span class="co">##             x + beta) + lgamma(x + alpha) - lgamma(n - x + 1) - </span></span>
<span><span class="co">##             lgamma(x + 1) - lgamma(n + alpha + beta) - lgamma(beta) - </span></span>
<span><span class="co">##             lgamma(alpha))</span></span>
<span><span class="co">##         dim(val) &lt;- c(na, n + 1)</span></span>
<span><span class="co">##         return(val)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     avoid_zero_vec &lt;- function(a) {</span></span>
<span><span class="co">##         (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - pmax(a * </span></span>
<span><span class="co">##             1000, 0))))/1000</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     avoid_zero &lt;- function(a) {</span></span>
<span><span class="co">##         (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - pmax(a * </span></span>
<span><span class="co">##             1000, 0))))/1000</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_matrix_wgt &lt;- function(delta_w) {</span></span>
<span><span class="co">##         na &lt;- dim(delta_w)[[1]]</span></span>
<span><span class="co">##         n &lt;- dim(delta_w)[[2]] - 1</span></span>
<span><span class="co">##         wgt.matrix &lt;- array(0, c(na, na))</span></span>
<span><span class="co">##         for (lg in 1:na) {</span></span>
<span><span class="co">##             if (lg == na) {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:na] &lt;- delta_w[lg, 1:(na - </span></span>
<span><span class="co">##                   lg + 1)]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else if (lg + n &gt; na) {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:na] &lt;- delta_w[lg, 1:(na - </span></span>
<span><span class="co">##                   lg + 1)]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:(n + lg)] &lt;- delta_w[lg, ]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(wgt.matrix)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_matrix_len &lt;- function(delta_l) {</span></span>
<span><span class="co">##         na &lt;- dim(delta_l)[[1]]</span></span>
<span><span class="co">##         n &lt;- dim(delta_l)[[2]] - 1</span></span>
<span><span class="co">##         growth.matrix &lt;- array(0, c(na, na))</span></span>
<span><span class="co">##         for (lg in 1:na) {</span></span>
<span><span class="co">##             if (lg == na) {</span></span>
<span><span class="co">##                 growth.matrix[na, na] &lt;- sum(delta_l[lg, ])</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else if (lg + n &gt; na) {</span></span>
<span><span class="co">##                 growth.matrix[lg, lg:(na - 1)] &lt;- delta_l[lg, </span></span>
<span><span class="co">##                   1:(na - lg)]</span></span>
<span><span class="co">##                 growth.matrix[lg, na] &lt;- sum(delta_l[lg, (na - </span></span>
<span><span class="co">##                   lg + 1):(n + 1)])</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else {</span></span>
<span><span class="co">##                 growth.matrix[lg, lg:(n + lg)] &lt;- delta_l[lg, </span></span>
<span><span class="co">##                   ]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(growth.matrix)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_apply &lt;- function(growth.matrix, wgt.matrix, input_num, </span></span>
<span><span class="co">##         input_wgt) {</span></span>
<span><span class="co">##         na &lt;- dim(growth.matrix)[[1]]</span></span>
<span><span class="co">##         avoid_zero_vec &lt;- function(a) {</span></span>
<span><span class="co">##             (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - </span></span>
<span><span class="co">##                 pmax(a * 1000, 0))))/1000</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         growth.matrix &lt;- growth.matrix * as.vector(input_num)</span></span>
<span><span class="co">##         wgt.matrix &lt;- growth.matrix * (wgt.matrix + as.vector(input_wgt))</span></span>
<span><span class="co">##         growth.matrix.sum &lt;- colSums(growth.matrix)</span></span>
<span><span class="co">##         return(array(c(growth.matrix.sum, colSums(wgt.matrix)/avoid_zero_vec(growth.matrix.sum)), </span></span>
<span><span class="co">##             dim = c(na, 2)))</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     assert_msg &lt;- function(expr, message) {</span></span>
<span><span class="co">##         if (isFALSE(expr)) {</span></span>
<span><span class="co">##             warning(message)</span></span>
<span><span class="co">##             return(TRUE)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(FALSE)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     ling_imm__minage &lt;- 3L</span></span>
<span><span class="co">##     ling_imm__maxage &lt;- 10L</span></span>
<span><span class="co">##     ling_imm__growth_l &lt;- array(NA, dim = structure(6:5, names = c("length", </span></span>
<span><span class="co">##         "delta")), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), delta = c("0", </span></span>
<span><span class="co">##         "1", "2", "3", "4")))</span></span>
<span><span class="co">##     ling_imm__plusdl &lt;- 10</span></span>
<span><span class="co">##     ling_imm__growth_w &lt;- array(NA, dim = structure(6:5, names = c("length", </span></span>
<span><span class="co">##         "delta")), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), delta = c("0", </span></span>
<span><span class="co">##         "1", "2", "3", "4")))</span></span>
<span><span class="co">##     ling_imm__num &lt;- array(0, dim = c(length = 6L, area = 2L, </span></span>
<span><span class="co">##         age = 8L), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), area = c("area1", </span></span>
<span><span class="co">##         "area2"), age = c("age3", "age4", "age5", "age6", "age7", </span></span>
<span><span class="co">##         "age8", "age9", "age10")))</span></span>
<span><span class="co">##     ling_imm__wgt &lt;- array(1, dim = c(length = 6L, area = 2L, </span></span>
<span><span class="co">##         age = 8L), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), area = c("area1", </span></span>
<span><span class="co">##         "area2"), age = c("age3", "age4", "age5", "age6", "age7", </span></span>
<span><span class="co">##         "age8", "age9", "age10")))</span></span>
<span><span class="co">##     ling_imm__prevtotal &lt;- 0</span></span>
<span><span class="co">##     while (TRUE) {</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             comment("g3a_grow for ling_imm")</span></span>
<span><span class="co">##             for (age in seq(ling_imm__minage, ling_imm__maxage, </span></span>
<span><span class="co">##                 by = 1)) {</span></span>
<span><span class="co">##                 ling_imm__age_idx &lt;- age - ling_imm__minage + </span></span>
<span><span class="co">##                   1L</span></span>
<span><span class="co">##                 for (ling_imm__area_idx in seq_along(ling_imm__areas)) {</span></span>
<span><span class="co">##                   area &lt;- ling_imm__areas[[ling_imm__area_idx]]</span></span>
<span><span class="co">##                   growth_delta_l &lt;- (ling_imm__growth_l[] &lt;- growth_bbinom(avoid_zero_vec((age * </span></span>
<span><span class="co">##                     10)/ling_imm__plusdl), 4L, avoid_zero(param[["ling.bbin"]])))</span></span>
<span><span class="co">##                   growth_delta_w &lt;- (ling_imm__growth_w[] &lt;- area * </span></span>
<span><span class="co">##                     20)</span></span>
<span><span class="co">##                   growthmat_w &lt;- g3a_grow_matrix_wgt(growth_delta_w)</span></span>
<span><span class="co">##                   growthmat_l &lt;- g3a_grow_matrix_len(growth_delta_l)</span></span>
<span><span class="co">##                   growthresult &lt;- g3a_grow_apply(growthmat_l, </span></span>
<span><span class="co">##                     growthmat_w, ling_imm__num[, ling_imm__area_idx, </span></span>
<span><span class="co">##                       ling_imm__age_idx], ling_imm__wgt[, ling_imm__area_idx, </span></span>
<span><span class="co">##                       ling_imm__age_idx])</span></span>
<span><span class="co">##                   {</span></span>
<span><span class="co">##                     if (FALSE) </span></span>
<span><span class="co">##                       ling_imm__prevtotal &lt;- sum(ling_imm__num[, </span></span>
<span><span class="co">##                         ling_imm__area_idx, ling_imm__age_idx])</span></span>
<span><span class="co">##                     comment("Update ling_imm using delta matrices")</span></span>
<span><span class="co">##                     ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, </span></span>
<span><span class="co">##                       (1)]</span></span>
<span><span class="co">##                     ling_imm__wgt[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, </span></span>
<span><span class="co">##                       (2)]</span></span>
<span><span class="co">##                     if (FALSE) </span></span>
<span><span class="co">##                       assert_msg(~abs(ling_imm__prevtotal - sum(ling_imm__num[, </span></span>
<span><span class="co">##                         ling_imm__area_idx, ling_imm__age_idx])) &lt; </span></span>
<span><span class="co">##                         1e-04, "g3a_growmature: ling_imm__num totals are not the same before and after growth")</span></span>
<span><span class="co">##                   }</span></span>
<span><span class="co">##                 }</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55ed66c98f28&gt;</span></span>
<span><span class="co">## &lt;environment: 0x55ed66f7c690&gt;</span></span></code></pre>
<p>…you can see our provided formula have been used to calculate
<code>ling_imm__growth_l</code> and <code>ling_imm__growth_w</code>, and
<code>age</code> and <code>area</code> are available to us thanks to the
loops provided by the stock.</p>
<p>We can also define formulas and reference them. Gadget3 will add the
definitions into the code where appropriate. For example:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_delta_l</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">area</span> <span class="op">*</span> <span class="fl">99</span></span>
<span><span class="va">custom_delta_w</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">ling_imm__plusdl</span> <span class="op">*</span> <span class="fl">44</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="../reference/action_grow.html">g3a_growmature</a></span><span class="op">(</span></span>
<span>    <span class="va">ling_imm</span>,</span>
<span>    impl_f <span class="op">=</span> <span class="fu"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span><span class="op">(</span></span>
<span>        delta_len_f <span class="op">=</span> <span class="op">~</span><span class="va">age</span> <span class="op">*</span> <span class="va">custom_delta_l</span> <span class="op">*</span> <span class="fl">10</span>,</span>
<span>        delta_wgt_f <span class="op">=</span> <span class="op">~</span><span class="va">area</span> <span class="op">*</span> <span class="va">custom_delta_w</span> <span class="op">*</span> <span class="fl">20</span>,</span>
<span>        beta_f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">"ling.bbin"</span><span class="op">)</span>,</span>
<span>        maxlengthgroupgrowth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    transition_f <span class="op">=</span> <span class="op">~</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fn</span></span></code></pre></div>
<pre><code><span><span class="co">## function (param = attr(get(sys.call()[[1]]), "parameter_template")) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     stopifnot("ling.bbin" %in% names(param))</span></span>
<span><span class="co">##     growth_bbinom &lt;- function(delt_l, binn, beta) {</span></span>
<span><span class="co">##         alpha &lt;- (beta * delt_l)/(binn - delt_l)</span></span>
<span><span class="co">##         x &lt;- 0:binn</span></span>
<span><span class="co">##         na &lt;- length(alpha)</span></span>
<span><span class="co">##         n &lt;- length(x) - 1</span></span>
<span><span class="co">##         alpha &lt;- rep(alpha, n + 1)</span></span>
<span><span class="co">##         x &lt;- rep(x, each = na)</span></span>
<span><span class="co">##         val &lt;- exp(lgamma(n + 1) + lgamma(alpha + beta) + lgamma(n - </span></span>
<span><span class="co">##             x + beta) + lgamma(x + alpha) - lgamma(n - x + 1) - </span></span>
<span><span class="co">##             lgamma(x + 1) - lgamma(n + alpha + beta) - lgamma(beta) - </span></span>
<span><span class="co">##             lgamma(alpha))</span></span>
<span><span class="co">##         dim(val) &lt;- c(na, n + 1)</span></span>
<span><span class="co">##         return(val)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     avoid_zero_vec &lt;- function(a) {</span></span>
<span><span class="co">##         (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - pmax(a * </span></span>
<span><span class="co">##             1000, 0))))/1000</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     avoid_zero &lt;- function(a) {</span></span>
<span><span class="co">##         (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - pmax(a * </span></span>
<span><span class="co">##             1000, 0))))/1000</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_matrix_wgt &lt;- function(delta_w) {</span></span>
<span><span class="co">##         na &lt;- dim(delta_w)[[1]]</span></span>
<span><span class="co">##         n &lt;- dim(delta_w)[[2]] - 1</span></span>
<span><span class="co">##         wgt.matrix &lt;- array(0, c(na, na))</span></span>
<span><span class="co">##         for (lg in 1:na) {</span></span>
<span><span class="co">##             if (lg == na) {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:na] &lt;- delta_w[lg, 1:(na - </span></span>
<span><span class="co">##                   lg + 1)]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else if (lg + n &gt; na) {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:na] &lt;- delta_w[lg, 1:(na - </span></span>
<span><span class="co">##                   lg + 1)]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else {</span></span>
<span><span class="co">##                 wgt.matrix[lg, lg:(n + lg)] &lt;- delta_w[lg, ]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(wgt.matrix)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_matrix_len &lt;- function(delta_l) {</span></span>
<span><span class="co">##         na &lt;- dim(delta_l)[[1]]</span></span>
<span><span class="co">##         n &lt;- dim(delta_l)[[2]] - 1</span></span>
<span><span class="co">##         growth.matrix &lt;- array(0, c(na, na))</span></span>
<span><span class="co">##         for (lg in 1:na) {</span></span>
<span><span class="co">##             if (lg == na) {</span></span>
<span><span class="co">##                 growth.matrix[na, na] &lt;- sum(delta_l[lg, ])</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else if (lg + n &gt; na) {</span></span>
<span><span class="co">##                 growth.matrix[lg, lg:(na - 1)] &lt;- delta_l[lg, </span></span>
<span><span class="co">##                   1:(na - lg)]</span></span>
<span><span class="co">##                 growth.matrix[lg, na] &lt;- sum(delta_l[lg, (na - </span></span>
<span><span class="co">##                   lg + 1):(n + 1)])</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             else {</span></span>
<span><span class="co">##                 growth.matrix[lg, lg:(n + lg)] &lt;- delta_l[lg, </span></span>
<span><span class="co">##                   ]</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(growth.matrix)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     g3a_grow_apply &lt;- function(growth.matrix, wgt.matrix, input_num, </span></span>
<span><span class="co">##         input_wgt) {</span></span>
<span><span class="co">##         na &lt;- dim(growth.matrix)[[1]]</span></span>
<span><span class="co">##         avoid_zero_vec &lt;- function(a) {</span></span>
<span><span class="co">##             (pmax(a * 1000, 0) + log1p(exp(pmin(a * 1000, 0) - </span></span>
<span><span class="co">##                 pmax(a * 1000, 0))))/1000</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         growth.matrix &lt;- growth.matrix * as.vector(input_num)</span></span>
<span><span class="co">##         wgt.matrix &lt;- growth.matrix * (wgt.matrix + as.vector(input_wgt))</span></span>
<span><span class="co">##         growth.matrix.sum &lt;- colSums(growth.matrix)</span></span>
<span><span class="co">##         return(array(c(growth.matrix.sum, colSums(wgt.matrix)/avoid_zero_vec(growth.matrix.sum)), </span></span>
<span><span class="co">##             dim = c(na, 2)))</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     assert_msg &lt;- function(expr, message) {</span></span>
<span><span class="co">##         if (isFALSE(expr)) {</span></span>
<span><span class="co">##             warning(message)</span></span>
<span><span class="co">##             return(TRUE)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         return(FALSE)</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     ling_imm__plusdl &lt;- 10</span></span>
<span><span class="co">##     ling_imm__minage &lt;- 3L</span></span>
<span><span class="co">##     ling_imm__maxage &lt;- 10L</span></span>
<span><span class="co">##     ling_imm__growth_w &lt;- array(NA, dim = structure(6:5, names = c("length", </span></span>
<span><span class="co">##         "delta")), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), delta = c("0", </span></span>
<span><span class="co">##         "1", "2", "3", "4")))</span></span>
<span><span class="co">##     ling_imm__growth_l &lt;- array(NA, dim = structure(6:5, names = c("length", </span></span>
<span><span class="co">##         "delta")), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), delta = c("0", </span></span>
<span><span class="co">##         "1", "2", "3", "4")))</span></span>
<span><span class="co">##     ling_imm__num &lt;- array(0, dim = c(length = 6L, area = 2L, </span></span>
<span><span class="co">##         age = 8L), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), area = c("area1", </span></span>
<span><span class="co">##         "area2"), age = c("age3", "age4", "age5", "age6", "age7", </span></span>
<span><span class="co">##         "age8", "age9", "age10")))</span></span>
<span><span class="co">##     ling_imm__wgt &lt;- array(1, dim = c(length = 6L, area = 2L, </span></span>
<span><span class="co">##         age = 8L), dimnames = list(length = c("0:10", "10:20", </span></span>
<span><span class="co">##         "20:30", "30:40", "40:50", "50:Inf"), area = c("area1", </span></span>
<span><span class="co">##         "area2"), age = c("age3", "age4", "age5", "age6", "age7", </span></span>
<span><span class="co">##         "age8", "age9", "age10")))</span></span>
<span><span class="co">##     ling_imm__prevtotal &lt;- 0</span></span>
<span><span class="co">##     while (TRUE) {</span></span>
<span><span class="co">##         {</span></span>
<span><span class="co">##             custom_delta_w &lt;- (ling_imm__plusdl * 44)</span></span>
<span><span class="co">##             {</span></span>
<span><span class="co">##                 comment("g3a_grow for ling_imm")</span></span>
<span><span class="co">##                 for (age in seq(ling_imm__minage, ling_imm__maxage, </span></span>
<span><span class="co">##                   by = 1)) {</span></span>
<span><span class="co">##                   ling_imm__age_idx &lt;- age - ling_imm__minage + </span></span>
<span><span class="co">##                     1L</span></span>
<span><span class="co">##                   for (ling_imm__area_idx in seq_along(ling_imm__areas)) {</span></span>
<span><span class="co">##                     area &lt;- ling_imm__areas[[ling_imm__area_idx]]</span></span>
<span><span class="co">##                     growth_delta_w &lt;- (ling_imm__growth_w[] &lt;- area * </span></span>
<span><span class="co">##                       custom_delta_w * 20)</span></span>
<span><span class="co">##                     custom_delta_l &lt;- (area * 99)</span></span>
<span><span class="co">##                     growth_delta_l &lt;- (ling_imm__growth_l[] &lt;- growth_bbinom(avoid_zero_vec((age * </span></span>
<span><span class="co">##                       custom_delta_l * 10)/ling_imm__plusdl), </span></span>
<span><span class="co">##                       4L, avoid_zero(param[["ling.bbin"]])))</span></span>
<span><span class="co">##                     growthmat_w &lt;- g3a_grow_matrix_wgt(growth_delta_w)</span></span>
<span><span class="co">##                     growthmat_l &lt;- g3a_grow_matrix_len(growth_delta_l)</span></span>
<span><span class="co">##                     growthresult &lt;- g3a_grow_apply(growthmat_l, </span></span>
<span><span class="co">##                       growthmat_w, ling_imm__num[, ling_imm__area_idx, </span></span>
<span><span class="co">##                         ling_imm__age_idx], ling_imm__wgt[, ling_imm__area_idx, </span></span>
<span><span class="co">##                         ling_imm__age_idx])</span></span>
<span><span class="co">##                     {</span></span>
<span><span class="co">##                       if (FALSE) </span></span>
<span><span class="co">##                         ling_imm__prevtotal &lt;- sum(ling_imm__num[, </span></span>
<span><span class="co">##                           ling_imm__area_idx, ling_imm__age_idx])</span></span>
<span><span class="co">##                       comment("Update ling_imm using delta matrices")</span></span>
<span><span class="co">##                       ling_imm__num[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, </span></span>
<span><span class="co">##                         (1)]</span></span>
<span><span class="co">##                       ling_imm__wgt[, ling_imm__area_idx, ling_imm__age_idx] &lt;- growthresult[, </span></span>
<span><span class="co">##                         (2)]</span></span>
<span><span class="co">##                       if (FALSE) </span></span>
<span><span class="co">##                         assert_msg(~abs(ling_imm__prevtotal - </span></span>
<span><span class="co">##                           sum(ling_imm__num[, ling_imm__area_idx, </span></span>
<span><span class="co">##                             ling_imm__age_idx])) &lt; 1e-04, "g3a_growmature: ling_imm__num totals are not the same before and after growth")</span></span>
<span><span class="co">##                     }</span></span>
<span><span class="co">##                   }</span></span>
<span><span class="co">##                 }</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;bytecode: 0x55ed66e070d8&gt;</span></span>
<span><span class="co">## &lt;environment: 0x55ed66dc2178&gt;</span></span></code></pre>
<p>Note that <code>custom_delta_l</code> is recalculated every loop,
since it uses <code>area</code>, whereas <code>custom_delta_w</code> is
calculated once for the step.</p>
</div>
<div class="section level2">
<h2 id="model-parameterization">Model parameterization<a class="anchor" aria-label="anchor" href="#model-parameterization"></a>
</h2>
<p>In the <code>g3a_growmature</code> function above, we see a reference
to <code>g3_param("ling.bbin")</code>. The <code><a href="../reference/language.html">g3_param()</a></code>
function is pseudo-code that specifies the model should accept a
parameter at this point. In the R code, this has been converted to
<code>param[["ling.bbin"]]</code>, so when we call our R function, we
can provide a value, e.g. <code>fn(list(ling.bbin = 6))</code>. We can
also use <code><a href="../reference/language.html">g3_param_vector()</a></code> to provide a model with a vector
of values. See <code><a href="../reference/language.html">?g3_param</a></code> for more information on this and
other functions available to you.</p>
<p>When converting to TMB, there are a lot more options for using the
optimisation features it offers.</p>
</div>
<div class="section level2">
<h2 id="combining-actions">Combining actions<a class="anchor" aria-label="anchor" href="#combining-actions"></a>
</h2>
<p>Any useful model will have multiple actions, so the outputs from the
<code>g3a_</code> functions need to be combined. To do this, you can
pass a list of actions to any of the <code>g3_to_*</code> functions, for
example:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ling_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_age.html">g3a_age</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/action_grow.html">g3a_growmature</a></span><span class="op">(</span></span>
<span>        <span class="va">ling_imm</span>,</span>
<span>        impl_f <span class="op">=</span> <span class="fu"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span><span class="op">(</span></span>
<span>            delta_len_f <span class="op">=</span> <span class="op">~</span><span class="va">age</span> <span class="op">*</span> <span class="fl">10</span>,</span>
<span>            delta_wgt_f <span class="op">=</span> <span class="op">~</span><span class="va">area</span> <span class="op">*</span> <span class="fl">20</span>,</span>
<span>            beta_f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">"ling.bbin"</span><span class="op">)</span>,</span>
<span>            maxlengthgroupgrowth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1999</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A useful technique is to break down the actions into separate lists,
e.g.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ling_imm_actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_age.html">g3a_age</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/action_grow.html">g3a_growmature</a></span><span class="op">(</span></span>
<span>        <span class="va">ling_imm</span>,</span>
<span>        impl_f <span class="op">=</span> <span class="fu"><a href="../reference/action_grow.html">g3a_grow_impl_bbinom</a></span><span class="op">(</span></span>
<span>            delta_len_f <span class="op">=</span> <span class="op">~</span><span class="va">age</span> <span class="op">*</span> <span class="fl">10</span>,</span>
<span>            delta_wgt_f <span class="op">=</span> <span class="op">~</span><span class="va">area</span> <span class="op">*</span> <span class="fl">20</span>,</span>
<span>            beta_f <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">"ling.bbin"</span><span class="op">)</span>,</span>
<span>            maxlengthgroupgrowth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_actions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/action_time.html">g3a_time</a></span><span class="op">(</span><span class="fl">1990</span>, <span class="fl">1999</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ling_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_r.html">g3_to_r</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ling_imm_actions</span>, <span class="va">time_actions</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Your actions can be combined in any order, the reasons for why are in
the next section.</p>
</div>
<div class="section level2">
<h2 id="ordering-of-actions">Ordering of actions<a class="anchor" aria-label="anchor" href="#ordering-of-actions"></a>
</h2>
<p>Gadget2 has a strict <a href="https://gadget-framework.github.io/gadget2/userguide/chap-order.html" class="external-link">Order
of Calculations</a>, and re-ordering calculations may well have averse
effects. Actions also have common steps to perform, for example
overstocking for a prey has to be calculated, and calculated once, after
each fleet has finished harvesting.</p>
<p>To manage this, formulas within an action are labelled with a string,
for example:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lln</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stock.html">g3_fleet</a></span><span class="op">(</span><span class="st">'lln'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/stock_areas.html">g3s_livesonareas</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">action</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/action_predate.html">g3a_predate_fleet</a></span><span class="op">(</span></span>
<span>        <span class="va">lln</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">ling_imm</span><span class="op">)</span>,</span>
<span>        suitabilities <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            ling_imm <span class="op">=</span> <span class="fu"><a href="../reference/suitability.html">g3_suitability_exponentiall50</a></span><span class="op">(</span></span>
<span>                <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">'ling.lln.alpha'</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">'ling.lln.l50'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            ling_mat <span class="op">=</span> <span class="fu"><a href="../reference/suitability.html">g3_suitability_exponentiall50</a></span><span class="op">(</span></span>
<span>                <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">'ling.lln.alpha'</span><span class="op">)</span>,</span>
<span>                <span class="op">~</span><span class="fu"><a href="../reference/language.html">g3_param</a></span><span class="op">(</span><span class="st">'ling.lln.l50'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        catchability_f <span class="op">=</span> <span class="fu"><a href="../reference/action_predate.html">g3a_predate_catchability_totalfleet</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">action</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "000:000:g3a_suitability_report:lln                 :ling_imm            "                   </span></span>
<span><span class="co">## [2] "003:g3a_predate         :005:lln                 :ling_imm            "                     </span></span>
<span><span class="co">## [3] "003:g3a_predate         :004:ling_imm            "                                          </span></span>
<span><span class="co">## [4] "003:g3a_predate         :000:000:ling_imm            "                                      </span></span>
<span><span class="co">## [5] "003:g3a_predate         :000:001:lln                 "                                      </span></span>
<span><span class="co">## [6] "003:g3a_predate         :001:lln                 :ling_imm            :be1c9cb11c841a862f53"</span></span>
<span><span class="co">## [7] "003:g3a_predate         :002:lln                 :ling_imm            :be1c9cb11c841a862f53"</span></span>
<span><span class="co">## [8] "003:g3a_predate         :099:lln                 :ling_imm            "</span></span></code></pre>
<p>We see each step has a colon-separated name, including the following
parts:</p>
<ul>
<li>A number corresponding to the order of calculations. If you look at
the gadget2 user-guide, consumption is step 3. This can be controlled
using the <code>run_at</code> parameter of
<code><a href="../reference/action_predate.html">g3a_predate_fleet()</a></code>, or any other action.</li>
<li>Another number specifying the order within an action this step
should be performed.</li>
<li>The prey and where relevant the fleet name</li>
<li>A hash, that corresponds to the parameters of the
<code><a href="../reference/action_predate.html">g3a_predate_fleet()</a></code> call.</li>
</ul>
<p>When a G3 model is made, it will sort the combined list of steps by
name, and remove duplicates by name. This means that:</p>
<ul>
<li>Predation will happen at the correct part of the model cycle.</li>
<li>Predation steps themselves will be ordered. So all defined predation
steps will collect their catch (<code>003:001</code>) before
overconsumption is calculated (<code>003:004</code>). There’s no explict
process needed to interleave multiple predation actions.</li>
<li>The overconsumption co-efficient for ling_imm will only be
calculated once, regardless of the number of predation actions, since we
will remove the duplicate versions of this step.</li>
<li>Conversely the hash ensures that there are never duplicate versions
of the main predation step, so could be repated. This is more relevant
for renewal, where there can be multiple renewal actions working on the
same stock.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jamie Lentin, Bjarki Thor Elvarsson, William Butler.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
