library(magrittr)
library(unittest)

library(gadget3)

# Zip name/value arguments together into a list
named_list <- function(...) {
    x <- list(...)
    structure(
        x[seq_along(x) %% 2 == 0],
        names = as.character(x[seq_along(x) %% 2 == 1]))
}

# NB: Name has to be different, or it gets sucked into the model
g3_avoid_zero <- gadget3:::g3_global_env$avoid_zero
g3_logspace_add <- gadget3:::g3_global_env$logspace_add
g3_logspace_add_vec <- gadget3:::g3_global_env$logspace_add_vec
g3_lgamma_vec <- lgamma

ok(grepl(
    'stock_ssinv\\(modelstock__x,\\s+"time",\\s+"area",\\s+"age"\\)',
    paste(deparse(g3l_distribution_sumofsquares(c('area', 'age'))), collapse = ""),
    perl = TRUE), "Added custom totals to sumofsquares modelstock__x")
ok(grepl(
    'stock_ssinv\\(obsstock__x,\\s+"time",\\s+"area",\\s+"age"\\)',
    paste(deparse(g3l_distribution_sumofsquares(c('area', 'age'))), collapse = ""),
    perl = TRUE), "Added custom totals to sumofsquares obsstock__x")


# NB: Also added some aggregate areas for fleet data
areas <- list(a = 1, b = 2, c = 3, x = 1:2, y = 3)
prey_a <- g3_stock('prey_a', seq(1, 10)) %>% g3s_livesonareas(areas[c('a')])
prey_b <- g3_stock('prey_b', seq(1, 10)) %>% g3s_livesonareas(areas[c('b')])
prey_c <- g3_stock('prey_c', seq(1, 10)) %>% g3s_livesonareas(areas[c('c')])
fleet_abc <- g3_fleet('fleet_abc') %>% g3s_livesonareas(areas[c('a', 'b', 'c')])

# Generate observation data for stock distribution
# NB: No prey_b, only compare prey_a and prey_c
sd_data <- expand.grid(year = 1999:2000, step = c(1, 2), area = c('x', 'y'), stock = c("prey_a", "prey_c"), length = c(1,6))
sd_data$number <- floor(runif(length(sd_data$year), min=100, max=999))

# Generate observation data for catch distribution
cd_data <- expand.grid(year = 1999:2000, step = c(1, 2), area = c('x', 'y'), length = c(1,6))
cd_data$number <- floor(runif(length(cd_data$year), min=100, max=999))

# Generate observation data for catch distribution by biomass
cd_weight_data <- expand.grid(year = 1999:2000, step = c(1, 2), area = c('x', 'y'), length = c(1,6))
cd_weight_data$weight <- floor(runif(length(cd_data$year), min=1000, max=9999))

# Generate observation data for catch distribution (multinomial)
multinomial_data <- expand.grid(year = 1999:2000, step = c(1, 2), length = c(1,6))
multinomial_data$number <- floor(runif(length(multinomial_data$year), min=100, max=999))

surveyindices_data <- expand.grid(year = 1999:2000, step = c(1, 2))
surveyindices_data$number <- floor(runif(length(surveyindices_data$year), min=100, max=999))

# Generate a step that reports the value of (var_name) into separate variable (steps) times
# (initial_val) provides a definition to use to set variable type
report_step <- function (var_name, steps, initial_val) {
    out <- ~{}
    for (i in seq(steps - 1, 0, by = -1)) {
        step_var_name <- paste0("step", i, "_", var_name)
        assign(step_var_name, initial_val)
        out <- gadget3:::f_substitute(~if (cur_time == i) {
            comment(report_comment)
            step_var[] <- var
            g3_report(step_var)
        } else rest, list(
            report_comment = paste0("Reporting on ", var_name, " at step ", i),
            step_var = as.symbol(step_var_name),
            var = as.symbol(var_name),
            i = i,
            rest = out))
    }
    return(out)
}

base_actions <- list(
    g3a_time(1999,2000, steps = c(6, 6)),
    g3a_initialconditions(prey_a, ~10 * prey_a__midlen, ~100 * prey_a__midlen),
    g3a_initialconditions(prey_b, ~10 * prey_b__midlen, ~100 * prey_b__midlen),
    g3a_initialconditions(prey_c, ~10 * prey_c__midlen, ~100 * prey_c__midlen),
    g3a_predate_totalfleet(
        fleet_abc,
        list(prey_a, prey_b, prey_c),
        suitabilities = list(
            prey_a = ~g3_param_vector("fleet_abc_a"),
            prey_b = ~g3_param_vector("fleet_abc_b"),
            prey_c = ~g3_param_vector("fleet_abc_c")),
        amount_f = ~g3_param('amount_ab') * area),
    named_list(
        # Capture data just before final step erases it
        gadget3:::step_id(10, 'g3l_distribution', 'utcd', 1, 'zzzz'), report_step('cdist_utcd_model__num', 4, array(
            # NB: Lift definition from deparse(r$cdist_utcd_model__num)
            dim = c(2L, 2L),
            dimnames = list(
                c("len1", "len6"),
                c("x", "y")))),
        gadget3:::step_id(10, 'g3l_distribution', 'utsd', 1, 'zzzz'), report_step('cdist_utsd_model__num', 4, array(
            # NB: Lift definition from deparse(r$cdist_utsd_model__num)
            dim = c(2L, 2L, 2L),
            dimnames = list(
                c("len1", "len6"),
                c("prey_a", "prey_c"),
                c("x", "y")))),
        gadget3:::step_id(10, 'g3l_distribution', 'utcd_weight', 1, 'zzzz'), report_step('cdist_utcd_weight_model__wgt', 4, array(
            # NB: Lift definition from deparse(r$cdist_utcd_weight_model__wgt)
            dim = c(2L, 2L),
            dimnames = list(
                c("len1", "len6"),
                c("x", "y")))),
        gadget3:::step_id(10, 'g3l_distribution', 'multinom', 1, 'zzzz'), report_step('cdist_multinom_model__num', 4, array(
            # NB: Lift definition from deparse(r$cdist_multinom_model__num)
            dim = c(2L),
            dimnames = list(
                c("len1", "len6")))),
        gadget3:::step_id(990, 'prey_a__fleet_abc'), report_step('prey_a__fleet_abc', 4, gadget3:::stock_instance(prey_a)),
        gadget3:::step_id(990, 'prey_b__fleet_abc'), report_step('prey_b__fleet_abc', 4, gadget3:::stock_instance(prey_b)),
        gadget3:::step_id(990, 'prey_c__fleet_abc'), report_step('prey_c__fleet_abc', 4, gadget3:::stock_instance(prey_c)),
        gadget3:::step_id(990, 'prey_a__num'), report_step('prey_a__num', 4, gadget3:::stock_instance(prey_a)),
        gadget3:::step_id(990, 'prey_b__num'), report_step('prey_b__num', 4, gadget3:::stock_instance(prey_b)),
        gadget3:::step_id(990, 'prey_c__num'), report_step('prey_c__num', 4, gadget3:::stock_instance(prey_c)),
        gadget3:::step_id(990, 'nll'), report_step('nll', 4, 0.0),
        gadget3:::step_id(999),  ~{
            g3_report(cdist_utcd_model__num)
            g3_report(cdist_utcd_obs__num)
            g3_report(cdist_utcd_weight_model__wgt)
            g3_report(cdist_utcd_weight_obs__wgt)
            g3_report(cdist_utsd_model__num)
            g3_report(cdist_utsd_obs__num)
            g3_report(cdist_multinom_model__num)
            g3_report(cdist_multinom_obs__num)
            g3_report(prey_a__wgt)
            g3_report(prey_b__wgt)
            g3_report(prey_c__wgt)
            g3_report(prey_a__num)
            g3_report(prey_b__num)
            g3_report(prey_c__num)

            # NB: In theory we could inspect the return value, but TMB doesn't give an easy public method for that
            g3_report(nll)
        }))
actions <- c(base_actions, list(
    g3l_catchdistribution(
        'utcd',
        cd_data,
        list(fleet_abc),
        list(prey_a, prey_b, prey_c),
        area_group = areas,
        g3l_distribution_sumofsquares()),
    g3l_catchdistribution(
        'utcd_weight',
        cd_weight_data,
        list(fleet_abc),
        list(prey_a, prey_b, prey_c),
        area_group = areas,
        g3l_distribution_sumofsquares()),
    g3l_catchdistribution(
        'utsd',
        sd_data,
        list(fleet_abc),
        list(prey_a, prey_b, prey_c),
        area_group = areas,
        g3l_distribution_sumofsquares()),
    g3l_catchdistribution(
        'multinom',
        multinomial_data,
        list(fleet_abc),
        list(prey_a),
        area_group = areas,
        g3l_distribution_multinomial()),
    g3l_distribution(
        'surveyindices',
        surveyindices_data,
        fleets = list(),
        stocks = list(prey_b),
        area_group = areas,
        report = TRUE,  # NB: Using built-in reporting vs. version hacked in tests
        g3l_distribution_surveyindices_log(alpha = ~g3_param("si_alpha"), beta = ~g3_param("si_beta"))),
    NULL))

params <- list(
    fleet_abc_a = c(0, 0, 0, 0.1, 0.2, 0.1, 0, 0, 0, 0),
    fleet_abc_b = c(0, 0, 0, 0, 0, 0.1, 0.2, 0.1, 0, 0),
    fleet_abc_c = c(0, 0, 0, 0, 0, 0, 0.1, 0.2, 0.1, 0),
    amount_ab = 100,
    si_alpha = 0,
    si_beta = 0,
    utcd_weight = 1,
    utcd_weight_weight = 1,
    utsd_weight = 1,
    multinom_weight = 1,
    surveyindices_weight = 1)

# Compile model
model_fn <- g3_to_r(actions, trace = FALSE)
# model_fn <- edit(model_fn)
if (nzchar(Sys.getenv('G3_TEST_TMB'))) {
    model_cpp <- g3_to_tmb(actions, trace = FALSE)
    # model_cpp <- edit(model_cpp)
    model_tmb <- g3_tmb_adfun(model_cpp, params, compile_flags = c("-O0", "-g"))
} else {
    writeLines("# skip: not compiling TMB model")
    model_cpp <- c()
}

ok_group("Likelihood per step", {
    params <- list(
        # Randomly catch, but get something everywhere
        fleet_abc_a = runif(10, min=0.1, max=0.9),
        fleet_abc_b = runif(10, min=0.1, max=0.9),
        fleet_abc_c = runif(10, min=0.1, max=0.9),
        amount_ab = 1000000,
        si_alpha = 4,
        si_beta = 2,
        utcd_weight = 1,
        utcd_weight_weight = 1,
        utsd_weight = 1,
        multinom_weight = 1,
        surveyindices_weight = 1)
    result <- model_fn(params)
    r <- attributes(result)
    # str(result)
    # str(as.list(r), vec.len = 10000)

    ok(ut_cmp_equal(
        sort(as.vector(r$cdist_utsd_obs__num)),
        sort(sd_data$number)), "cdist_utsd_obs__num: Imported from data.frame, order not necessarily the same")

    ok(ut_cmp_equal(
        r$cdist_surveyindices_model__params,
        c(alpha = params$si_alpha, beta = params$si_beta)), "cdist_surveyindices_model__params: Reported our hard-coded linear regression parameters")

    ######## cdist_utsd_model__num
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utsd_model__num[,'prey_a', 1]), c(
        sum(r$step0_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,]),
        sum(r$step0_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,]))), "step0_cdist_utsd_model__num[,'prey_a',1]: prey_a in area 1")
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utsd_model__num[,'prey_c', 1]), c(
        0,
        0)), "step0_cdist_utsd_model__num[,'prey_c',1]: No prey_c in area 1")
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utsd_model__num[,'prey_a', 2]), c(
        0,
        0)), "step0_cdist_utsd_model__num[,'prey_a',2]: No prey_a in area 2")
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utsd_model__num[,'prey_c', 2]), c(
        sum(r$step0_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,]),
        sum(r$step0_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,]))), "step0_cdist_utsd_model__num[,'prey_c',2]: prey_c in area 2")

    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_a', 1]), c(
        sum(r$step1_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,]),
        sum(r$step1_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,]))), "step1_cdist_utsd_model__num[,'prey_a',1]: prey_a in area 1")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_c', 1]), c(
        0,
        0)), "step1_cdist_utsd_model__num[,'prey_c',1]: No prey_c in area 1")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_a', 2]), c(
        0,
        0)), "step1_cdist_utsd_model__num[,'prey_a',2]: No prey_a in area 2")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_c', 2]), c(
        sum(r$step1_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,]),
        sum(r$step1_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,]))), "step1_cdist_utsd_model__num[,'prey_c',2]: prey_c in area 2")

    ok(ut_cmp_equal(as.vector(r$step2_cdist_utsd_model__num[,'prey_a', 1]), c(
        sum(r$step2_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,]),
        sum(r$step2_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,]))), "step2_cdist_utsd_model__num[,'prey_a',1]: prey_a in area 1")
    ok(ut_cmp_equal(as.vector(r$step2_cdist_utsd_model__num[,'prey_c', 1]), c(
        0,
        0)), "step2_cdist_utsd_model__num[,'prey_c',1]: No prey_c in area 1")
    ok(ut_cmp_equal(as.vector(r$step2_cdist_utsd_model__num[,'prey_a', 2]), c(
        0,
        0)), "step2_cdist_utsd_model__num[,'prey_a',2]: No prey_a in area 2")
    ok(ut_cmp_equal(as.vector(r$step2_cdist_utsd_model__num[,'prey_c', 2]), c(
        sum(r$step2_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,]),
        sum(r$step2_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,]))), "step2_cdist_utsd_model__num[,'prey_c',2]: prey_c in area 2")

    ok(ut_cmp_equal(as.vector(r$step3_cdist_utsd_model__num[,'prey_a', 1]), c(
        sum(r$step3_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,]),
        sum(r$step3_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,]))), "step3_cdist_utsd_model__num[,'prey_a',1]: prey_a in area 1")
    ok(ut_cmp_equal(as.vector(r$step3_cdist_utsd_model__num[,'prey_c', 1]), c(
        0,
        0)), "step3_cdist_utsd_model__num[,'prey_c',1]: No prey_c in area 1")
    ok(ut_cmp_equal(as.vector(r$step3_cdist_utsd_model__num[,'prey_a', 2]), c(
        0,
        0)), "step3_cdist_utsd_model__num[,'prey_a',2]: No prey_a in area 2")
    ok(ut_cmp_equal(as.vector(r$step3_cdist_utsd_model__num[,'prey_c', 2]), c(
        sum(r$step3_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,]),
        sum(r$step3_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,]))), "step3_cdist_utsd_model__num[,'prey_c',2]: prey_c in area 2")
    ########

    ######## cdist_utcd_model__num
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utcd_model__num[,1]), c(
         sum(
             sum(r$step0_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step0_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1])),
         sum(
             sum(r$step0_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step0_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1])),
         NULL)), "step0_cdist_utsd_model__num[,1]: all prey in area a/b")
    ok(ut_cmp_equal(as.vector(r$step0_cdist_utcd_model__num[,2]), c(
         sum(
             sum(r$step0_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1])),
         sum(
             sum(r$step0_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1])),
         NULL)), "step0_cdist_utsd_model__num[,2]: all prey in area c")

    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_model__num[,1]), c(
         sum(
             sum(r$step1_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step1_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1])),
         sum(
             sum(r$step1_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step1_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1])),
         NULL)), "step1_cdist_utsd_model__num[,1]: all prey in area a/b")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_model__num[,2]), c(
         sum(
             sum(r$step1_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1])),
         sum(
             sum(r$step1_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1])),
         NULL)), "step1_cdist_utsd_model__num[,2]: all prey in area c")

    ok(ut_cmp_equal(as.vector(r$step2_cdist_utcd_model__num[,1]), c(
         sum(
             sum(r$step2_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step2_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1])),
         sum(
             sum(r$step2_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step2_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1])),
         NULL)), "step2_cdist_utsd_model__num[,1]: all prey in area a/b")
    ok(ut_cmp_equal(as.vector(r$step2_cdist_utcd_model__num[,2]), c(
         sum(
             sum(r$step2_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1])),
         sum(
             sum(r$step2_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1])),
         NULL)), "step2_cdist_utsd_model__num[,2]: all prey in area c")

    ok(ut_cmp_equal(as.vector(r$step3_cdist_utcd_model__num[,1]), c(
         sum(
             sum(r$step3_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step3_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1])),
         sum(
             sum(r$step3_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step3_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1])),
         NULL)), "step3_cdist_utsd_model__num[,1]: all prey in area a/b")
    ok(ut_cmp_equal(as.vector(r$step3_cdist_utcd_model__num[,2]), c(
         sum(
             sum(r$step3_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1])),
         sum(
             sum(r$step3_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1])),
         NULL)), "step3_cdist_utsd_model__num[,2]: all prey in area c")
    ########

    ######## cdist_surveyindices_model__num
    ok(ut_cmp_equal(
        as.vector(r$cdist_surveyindices_model__num),
        c(
            sum(r$step0_prey_b__num),
            sum(r$step1_prey_b__num),
            sum(r$step2_prey_b__num),
            sum(r$step3_prey_b__num),
            NULL)), "cdist_surveyindices_model__num: Built-in reporting gave us step 0..3 abundance")
    ########

    ok(ut_cmp_equal(r$step0_nll, sum(
        # utsd: stock 1 / area 1
        (r$step0_cdist_utsd_model__num[,1,1] / sum(r$step0_cdist_utsd_model__num[,,1]) -
            r$cdist_utsd_obs__num[,1,1,1] / sum(r$cdist_utsd_obs__num[,,1,1])) ** 2,
        # utsd: stock 2 / area 1
        (r$step0_cdist_utsd_model__num[,2,1] / sum(r$step0_cdist_utsd_model__num[,,1]) -
            r$cdist_utsd_obs__num[,2,1,1] / sum(r$cdist_utsd_obs__num[,,1,1])) ** 2,
        # utsd: stock 1 / area 2
        (r$step0_cdist_utsd_model__num[,1,2] / sum(r$step0_cdist_utsd_model__num[,,2]) -
            r$cdist_utsd_obs__num[,1,1,2] / sum(r$cdist_utsd_obs__num[,,1,2])) ** 2,
        # utsd: stock 2 / area 2
        (r$step0_cdist_utsd_model__num[,2,2] / sum(r$step0_cdist_utsd_model__num[,,2]) -
            r$cdist_utsd_obs__num[,2,1,2] / sum(r$cdist_utsd_obs__num[,,1,2])) ** 2,
        # utcd: area 1
        (r$step0_cdist_utcd_model__num[,1] / sum(r$step0_cdist_utcd_model__num[,1]) -
            r$cdist_utcd_obs__num[,1,1] / sum(r$cdist_utcd_obs__num[,1,1])) ** 2,
        # utcd: area 2
        (r$step0_cdist_utcd_model__num[,2] / sum(r$step0_cdist_utcd_model__num[,2]) -
            r$cdist_utcd_obs__num[,1,2] / sum(r$cdist_utcd_obs__num[,1,2])) ** 2,
        # utcd_weight: area 1
        (r$step0_cdist_utcd_weight_model__wgt[,1] / g3_avoid_zero(sum(r$step0_cdist_utcd_weight_model__wgt[,1])) -
            r$cdist_utcd_weight_obs__wgt[,1,1] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,1,1]))) ** 2,
        # utcd_weight: area 2
        (r$step0_cdist_utcd_weight_model__wgt[,2] / g3_avoid_zero(sum(r$step0_cdist_utcd_weight_model__wgt[,2])) -
            r$cdist_utcd_weight_obs__wgt[,1,2] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,1,2]))) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,1] * log(g3_logspace_add_vec(r$step0_cdist_multinom_model__num/g3_avoid_zero(sum(r$step0_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,1]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,1])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,1]))))),
        # surveyindices:
        0,  # NB: We don't calculate until end
        0)), "step0_nll: Sum of squares")

    ok(ut_cmp_equal(r$step1_nll, sum(
        # utsd: stock 1 / area 1
        (r$step1_cdist_utsd_model__num[,1,1] / g3_avoid_zero(sum(r$step1_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,1,2,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,1]))) ** 2,
        # utsd: stock 2 / area 1
        (r$step1_cdist_utsd_model__num[,2,1] / g3_avoid_zero(sum(r$step1_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,2,2,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,1]))) ** 2,
        # utsd: stock 1 / area 2
        (r$step1_cdist_utsd_model__num[,1,2] / g3_avoid_zero(sum(r$step1_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,1,2,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,2]))) ** 2,
        # utsd: stock 2 / area 2
        (r$step1_cdist_utsd_model__num[,2,2] / g3_avoid_zero(sum(r$step1_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,2,2,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,2]))) ** 2,
        # utcd: area 1
        (r$step1_cdist_utcd_model__num[,1] / g3_avoid_zero(sum(r$step1_cdist_utcd_model__num[,1])) -
            r$cdist_utcd_obs__num[,2,1] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,2,1]))) ** 2,
        # utcd: area 2
        (r$step1_cdist_utcd_model__num[,2] / g3_avoid_zero(sum(r$step1_cdist_utcd_model__num[,2])) -
            r$cdist_utcd_obs__num[,2,2] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,2,2]))) ** 2,
        # utcd_weight: area 1
        (r$step1_cdist_utcd_weight_model__wgt[,1] / g3_avoid_zero(sum(r$step1_cdist_utcd_weight_model__wgt[,1])) -
            r$cdist_utcd_weight_obs__wgt[,2,1] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,2,1]))) ** 2,
        # utcd_weight: area 2
        (r$step1_cdist_utcd_weight_model__wgt[,2] / g3_avoid_zero(sum(r$step1_cdist_utcd_weight_model__wgt[,2])) -
            r$cdist_utcd_weight_obs__wgt[,2,2] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,2,2]))) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,2] * log(g3_logspace_add_vec(r$step1_cdist_multinom_model__num/g3_avoid_zero(sum(r$step1_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,2]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,2])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,2]))))),
        # surveyindices:
        0,  # NB: We don't calculate until end
        r$step0_nll)), "step1_nll: Sum of squares, including step0_nll")

    ok(ut_cmp_equal(r$step2_nll, sum(
        # utsd: stock 1 / area 1
        (r$step2_cdist_utsd_model__num[,1,1] / g3_avoid_zero(sum(r$step2_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,1,3,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,3,1]))) ** 2,
        # utsd: stock 2 / area 1
        (r$step2_cdist_utsd_model__num[,2,1] / g3_avoid_zero(sum(r$step2_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,2,3,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,3,1]))) ** 2,
        # utsd: stock 1 / area 2
        (r$step2_cdist_utsd_model__num[,1,2] / g3_avoid_zero(sum(r$step2_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,1,3,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,3,2]))) ** 2,
        # utsd: stock 2 / area 2
        (r$step2_cdist_utsd_model__num[,2,2] / g3_avoid_zero(sum(r$step2_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,2,3,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,3,2]))) ** 2,
        # utcd: area 1
        (r$step2_cdist_utcd_model__num[,1] / g3_avoid_zero(sum(r$step2_cdist_utcd_model__num[,1])) -
            r$cdist_utcd_obs__num[,3,1] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,3,1]))) ** 2,
        # utcd: area 2
        (r$step2_cdist_utcd_model__num[,2] / g3_avoid_zero(sum(r$step2_cdist_utcd_model__num[,2])) -
            r$cdist_utcd_obs__num[,3,2] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,3,2]))) ** 2,
        # utcd_weight: area 1
        (r$step2_cdist_utcd_weight_model__wgt[,1] / g3_avoid_zero(sum(r$step2_cdist_utcd_weight_model__wgt[,1])) -
            r$cdist_utcd_weight_obs__wgt[,3,1] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,3,1]))) ** 2,
        # utcd_weight: area 2
        (r$step2_cdist_utcd_weight_model__wgt[,2] / g3_avoid_zero(sum(r$step2_cdist_utcd_weight_model__wgt[,2])) -
            r$cdist_utcd_weight_obs__wgt[,3,2] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,3,2]))) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,3] * log(g3_logspace_add_vec(r$step2_cdist_multinom_model__num/g3_avoid_zero(sum(r$step2_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,3]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,3])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,3]))))),
        # surveyindices:
        0,  # NB: We don't calculate until end
        r$step1_nll)), "step2_nll: Sum of squares, including step1_nll")

    ok(ut_cmp_equal(r$step3_nll, sum(
        # utsd: stock 1 / area 1
        (r$step3_cdist_utsd_model__num[,1,1] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,1,4,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,4,1]))) ** 2,
        # utsd: stock 2 / area 1
        (r$step3_cdist_utsd_model__num[,2,1] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,2,4,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,4,1]))) ** 2,
        # utsd: stock 1 / area 2
        (r$step3_cdist_utsd_model__num[,1,2] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,1,4,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,4,2]))) ** 2,
        # utsd: stock 2 / area 2
        (r$step3_cdist_utsd_model__num[,2,2] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,2,4,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,4,2]))) ** 2,
        # utcd: area 1
        (r$step3_cdist_utcd_model__num[,1] / g3_avoid_zero(sum(r$step3_cdist_utcd_model__num[,1])) -
            r$cdist_utcd_obs__num[,4,1] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,4,1]))) ** 2,
        # utcd: area 2
        (r$step3_cdist_utcd_model__num[,2] / g3_avoid_zero(sum(r$step3_cdist_utcd_model__num[,2])) -
            r$cdist_utcd_obs__num[,4,2] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,4,2]))) ** 2,
        # utcd_weight: area 1
        (r$step3_cdist_utcd_weight_model__wgt[,1] / g3_avoid_zero(sum(r$step3_cdist_utcd_weight_model__wgt[,1])) -
            r$cdist_utcd_weight_obs__wgt[,4,1] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,4,1]))) ** 2,
        # utcd_weight: area 2
        (r$step3_cdist_utcd_weight_model__wgt[,2] / g3_avoid_zero(sum(r$step3_cdist_utcd_weight_model__wgt[,2])) -
            r$cdist_utcd_weight_obs__wgt[,4,2] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,4,2]))) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,4] * log(g3_logspace_add_vec(r$step3_cdist_multinom_model__num/g3_avoid_zero(sum(r$step3_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,4]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,4])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,4]))))),
        # surveyindices:
        sum((params$si_alpha +
            params$si_beta * log(g3_avoid_zero(r$cdist_surveyindices_model__num[,])) -
            log(g3_avoid_zero(r$cdist_surveyindices_obs__num[,])))**2),
        r$step2_nll)), "step3_nll: Sum of squares, including step2_nll")

    if (nzchar(Sys.getenv('G3_TEST_TMB'))) {
        param_template <- attr(model_cpp, "parameter_template")
        param_template$value <- params[param_template$switch]
        gadget3:::ut_tmb_r_compare(model_fn, model_tmb, param_template)
    }
})

ok_group("Likelihood per year", {
    # Change model to aggregate over a year
    # NB: No prey_b, only compare prey_a and prey_c
    # NB: No step column now
    sd_data <- expand.grid(year = 1999:2000, area = c('x', 'y'), stock = c("prey_a", "prey_c"), length = c(1,6))
    sd_data$number <- floor(runif(length(sd_data$year), min=100, max=999))
    attr(sd_data, 'area') <- list(
        x = areas[c('a', 'b')],
        y = areas[c('c')])

    # Change model to aggregate over a year
    # NB: No step column now
    cd_data <- expand.grid(year = 1999:2000, area = c('x', 'y'), length = c(1,6))
    cd_data$number <- floor(runif(length(cd_data$year), min=100, max=999))
    attr(cd_data, 'area') <- list(
        x = areas[c('a', 'b')],
        y = areas[c('c')])

    # Change model to aggregate over a year
    cd_weight_data <- expand.grid(year = 1999:2000, area = c('x', 'y'), length = c(1,6))
    cd_weight_data$weight <- floor(runif(length(cd_data$year), min=1000, max=9999))

    # Change model to aggregate over a year
    # NB: No step column now
    multinomial_data <- expand.grid(year = 1999:2000, length = c(1,6))
    multinomial_data$number <- floor(runif(length(multinomial_data$year), min=100, max=999))

    # NB: No step column now
    surveyindices_data <- expand.grid(year = 1999:2000)
    surveyindices_data$number <- floor(runif(length(surveyindices_data$year), min=100, max=999))

    actions <- c(base_actions, list(
        g3l_catchdistribution(
            'utcd',
            cd_data,
            list(fleet_abc),
            list(prey_a, prey_b, prey_c),
            area_group = areas,
            g3l_distribution_sumofsquares()),
        g3l_catchdistribution(
            'utcd_weight',
            cd_weight_data,
            list(fleet_abc),
            list(prey_a, prey_b, prey_c),
            area_group = areas,
            g3l_distribution_sumofsquares()),
        g3l_catchdistribution(
            'utsd',
            sd_data,
            list(fleet_abc),
            list(prey_a, prey_b, prey_c),
            area_group = areas,
            g3l_distribution_sumofsquares()),
        g3l_catchdistribution(
            'multinom',
            multinomial_data,
            list(fleet_abc),
            list(prey_a),
            area_group = areas,
            g3l_distribution_multinomial()),
        g3l_distribution(
            'surveyindices',
            surveyindices_data,
            fleets = list(),
            stocks = list(prey_b),
            area_group = areas,
            report = TRUE,
            g3l_distribution_surveyindices_log(alpha = ~g3_param("si_alpha"), beta = ~g3_param("si_beta")))))

    # Compile model
    model_fn <- g3_to_r(actions, trace = FALSE)
    # model_fn <- edit(model_fn)
    if (nzchar(Sys.getenv('G3_TEST_TMB'))) {
        model_cpp <- g3_to_tmb(actions, trace = FALSE)
        # model_cpp <- edit(model_cpp)
        model_tmb <- g3_tmb_adfun(model_cpp, params, compile_flags = c("-O0", "-g"))
    } else {
        writeLines("# skip: not compiling TMB model")
    }

    params <- list(
        fleet_abc_a = runif(10, min=0.1, max=0.9),
        fleet_abc_b = runif(10, min=0.1, max=0.9),
        fleet_abc_c = runif(10, min=0.1, max=0.9),
        amount_ab = 1000000,
        si_alpha = 1.82,
        si_beta = 3.74,
        utcd_weight = 1,
        utcd_weight_weight = 1,
        utsd_weight = 1,
        multinom_weight = 1,
        surveyindices_weight = 1)
    result <- model_fn(params)
    r <- attributes(result)
    # str(result)
    # str(as.list(r), vec.len = 10000)

    ok(ut_cmp_equal(
        sort(as.vector(r$cdist_utsd_obs__num)),
        sort(sd_data$number)), "cdist_utsd_obs__num: Imported from data.frame, order not necessarily the same")

    ok(ut_cmp_equal(
        r$cdist_surveyindices_model__params,
        c(alpha = params$si_alpha, beta = params$si_beta)), "cdist_surveyindices_model__params: Reported our hard-coded linear regression parameters")


    ######## cdist_utsd_model__num
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_a', 1]), c(
        sum(
            (r$step0_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,]),
            (r$step1_prey_a__fleet_abc[1:5,] / r$prey_a__wgt[1:5,])),
        sum(
            sum(r$step0_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,]),
            sum(r$step1_prey_a__fleet_abc[6:10,] / r$prey_a__wgt[6:10,])),
        NULL)), "step1_cdist_utsd_model__num[,'prey_a',1]: prey_a summed over year")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_c', 1]), c(
        0,
        0,
        NULL)), "step1_cdist_utsd_model__num[,'prey_c',1]: No prey_c in first area")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_a', 2]), c(
        0,
        0,
        NULL)), "step1_cdist_utsd_model__num[,'prey_a',2]: No prey_a in second area")
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utsd_model__num[,'prey_c', 2]), c(
        sum(
            (r$step0_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,]),
            (r$step1_prey_c__fleet_abc[1:5,] / r$prey_c__wgt[1:5,])),
        sum(
            sum(r$step0_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,]),
            sum(r$step1_prey_c__fleet_abc[6:10,] / r$prey_c__wgt[6:10,])),
        NULL)), "step1_cdist_utsd_model__num[,'prey_c',2]: prey_c summed over year")
    ########

    ######## cdist_utcd_model__num
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_model__num[,1]), c(
         sum(
             sum(r$step0_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step0_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1]),
             sum(r$step1_prey_a__fleet_abc[1:5,1] / r$prey_a__wgt[1:5,1]),
             sum(r$step1_prey_b__fleet_abc[1:5,1] / r$prey_b__wgt[1:5,1])),
         sum(
             sum(r$step0_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step0_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1]),
             sum(r$step1_prey_a__fleet_abc[6:10,1] / r$prey_a__wgt[6:10,1]),
             sum(r$step1_prey_b__fleet_abc[6:10,1] / r$prey_b__wgt[6:10,1])),
         NULL)), "step1_cdist_utcd_model__num[,1]: all prey from a/b and steps 0 & 1")

    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_model__num[,2]), c(
         sum(
             sum(r$step0_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1]),
             sum(r$step1_prey_c__fleet_abc[1:5,1] / r$prey_c__wgt[1:5,1])),
         sum(
             sum(r$step0_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1]),
             sum(r$step1_prey_c__fleet_abc[6:10,1] / r$prey_c__wgt[6:10,1])),
         NULL)), "step1_cdist_utcd_model__num[,2]: all prey from c and steps 0/1")
    ########

    ######## cdist_utcd_weight_model__wgt
    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_weight_model__wgt[,1]), c(
         sum(
             sum(r$step0_prey_a__fleet_abc[1:5,1]),
             sum(r$step0_prey_b__fleet_abc[1:5,1]),
             sum(r$step1_prey_a__fleet_abc[1:5,1]),
             sum(r$step1_prey_b__fleet_abc[1:5,1])),
         sum(
             sum(r$step0_prey_a__fleet_abc[6:10,1]),
             sum(r$step0_prey_b__fleet_abc[6:10,1]),
             sum(r$step1_prey_a__fleet_abc[6:10,1]),
             sum(r$step1_prey_b__fleet_abc[6:10,1])),
         NULL)), "step1_cdist_utcd_weight_model__wgt[,1]: total biomass of prey from a/b and steps 0 & 1")

    ok(ut_cmp_equal(as.vector(r$step1_cdist_utcd_weight_model__wgt[,2]), c(
         sum(
             sum(r$step0_prey_c__fleet_abc[1:5,1]),
             sum(r$step1_prey_c__fleet_abc[1:5,1])),
         sum(
             sum(r$step0_prey_c__fleet_abc[6:10,1]),
             sum(r$step1_prey_c__fleet_abc[6:10,1])),
         NULL)), "step1_cdist_utcd_weight_model__wgt[,2]: total biomass of prey from c and steps 0/1")
    ########

    ######## cdist_surveyindices_model__num
    ok(ut_cmp_equal(
        as.vector(r$cdist_surveyindices_model__num),
        c(
            sum(r$step0_prey_b__num) + sum(r$step1_prey_b__num),
            sum(r$step2_prey_b__num) + sum(r$step3_prey_b__num),
            NULL)), "cdist_surveyindices_model__num: Built-in reporting gave us step 0..3 abundance")
    ########

    ok(ut_cmp_equal(r$step0_nll, 0), "step0_nll: nll not calculated yet")

    ok(ut_cmp_equal(r$step1_nll, sum(
        # utsd: stock 1 / area 1
        (r$step1_cdist_utsd_model__num[,1,1] / sum(r$step1_cdist_utsd_model__num[,,1]) -
            # NB: Still using first time data, unlike per-step example
            r$cdist_utsd_obs__num[,1,1,1] / sum(r$cdist_utsd_obs__num[,,1,1])) ** 2,
        # utsd: stock 2 / area 1
        (r$step1_cdist_utsd_model__num[,2,1] / sum(r$step1_cdist_utsd_model__num[,,1]) -
            r$cdist_utsd_obs__num[,2,1,1] / sum(r$cdist_utsd_obs__num[,,1,1])) ** 2,
        # utsd: stock 1 / area 2
        (r$step1_cdist_utsd_model__num[,1,2] / sum(r$step1_cdist_utsd_model__num[,,2]) -
            r$cdist_utsd_obs__num[,1,1,2] / sum(r$cdist_utsd_obs__num[,,1,2])) ** 2,
        # utsd: stock 2 / area 2
        (r$step1_cdist_utsd_model__num[,2,2] / sum(r$step1_cdist_utsd_model__num[,,2]) -
            r$cdist_utsd_obs__num[,2,1,2] / sum(r$cdist_utsd_obs__num[,,1,2])) ** 2,
        # utcd: area 1
        (r$step1_cdist_utcd_model__num[,1] / sum(r$step1_cdist_utcd_model__num[,1]) -
            r$cdist_utcd_obs__num[,1,1] / sum(r$cdist_utcd_obs__num[,1,1])) ** 2,
        # utcd: area 2
        (r$step1_cdist_utcd_model__num[,2] / sum(r$step1_cdist_utcd_model__num[,2]) -
            r$cdist_utcd_obs__num[,1,2] / sum(r$cdist_utcd_obs__num[,1,2])) ** 2,
        # utcd_weight: area 1
        (r$step1_cdist_utcd_weight_model__wgt[,1] / sum(r$step1_cdist_utcd_weight_model__wgt[,1]) -
            r$cdist_utcd_weight_obs__wgt[,1,1] / sum(r$cdist_utcd_weight_obs__wgt[,1,1])) ** 2,
        # utcd_weight: area 2
        (r$step1_cdist_utcd_weight_model__wgt[,2] / sum(r$step1_cdist_utcd_weight_model__wgt[,2]) -
            r$cdist_utcd_weight_obs__wgt[,1,2] / sum(r$cdist_utcd_weight_obs__wgt[,1,2])) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,1] * log(g3_logspace_add_vec(r$step1_cdist_multinom_model__num/g3_avoid_zero(sum(r$step1_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,1]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,1])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,1]))))),
        # surveyindices:
        0,  # NB: We don't calculate until end
        0)), "step1_nll: Sum of squares")

    ok(ut_cmp_equal(r$step3_nll, sum(
        # utsd: stock 1 / area 1
        (r$step3_cdist_utsd_model__num[,1,1] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,1])) -
            # NB: Second time data, not 4th as in per-step example
            r$cdist_utsd_obs__num[,1,2,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,1]))) ** 2,
        # utsd: stock 2 / area 1
        (r$step3_cdist_utsd_model__num[,2,1] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,1])) -
            r$cdist_utsd_obs__num[,2,2,1] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,1]))) ** 2,
        # utsd: stock 1 / area 2
        (r$step3_cdist_utsd_model__num[,1,2] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,1,2,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,2]))) ** 2,
        # utsd: stock 2 / area 2
        (r$step3_cdist_utsd_model__num[,2,2] / g3_avoid_zero(sum(r$step3_cdist_utsd_model__num[,,2])) -
            r$cdist_utsd_obs__num[,2,2,2] / g3_avoid_zero(sum(r$cdist_utsd_obs__num[,,2,2]))) ** 2,
        # utcd: area 1
        (r$step3_cdist_utcd_model__num[,1] / g3_avoid_zero(sum(r$step3_cdist_utcd_model__num[,1])) -
            r$cdist_utcd_obs__num[,2,1] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,2,1]))) ** 2,
        # utcd: area 2
        (r$step3_cdist_utcd_model__num[,2] / g3_avoid_zero(sum(r$step3_cdist_utcd_model__num[,2])) -
            r$cdist_utcd_obs__num[,2,2] / g3_avoid_zero(sum(r$cdist_utcd_obs__num[,2,2]))) ** 2,
        # utcd_weight: area 1
        (r$step3_cdist_utcd_weight_model__wgt[,1] / g3_avoid_zero(sum(r$step3_cdist_utcd_weight_model__wgt[,1])) -
            r$cdist_utcd_weight_obs__wgt[,2,1] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,2,1]))) ** 2,
        # utcd_weight: area 2
        (r$step3_cdist_utcd_weight_model__wgt[,2] / g3_avoid_zero(sum(r$step3_cdist_utcd_weight_model__wgt[,2])) -
            r$cdist_utcd_weight_obs__wgt[,2,2] / g3_avoid_zero(sum(r$cdist_utcd_weight_obs__wgt[,2,2]))) ** 2,
        # multinom:
        (2 * (-sum(r$cdist_multinom_obs__num[,2] * log(g3_logspace_add_vec(r$step3_cdist_multinom_model__num/g3_avoid_zero(sum(r$step3_cdist_multinom_model__num)) *
            10000, (1/(length(r$cdist_multinom_obs__num[,2]) * 10)) * 10000)/10000)) +
                (sum(g3_lgamma_vec(1 + r$cdist_multinom_obs__num[,2])) - lgamma(1 +
                        sum(r$cdist_multinom_obs__num[,2]))))),
        # surveyindices:
        sum((params$si_alpha +
            params$si_beta * log(g3_avoid_zero(r$cdist_surveyindices_model__num[,])) -
            log(g3_avoid_zero(r$cdist_surveyindices_obs__num[,])))**2),
        r$step1_nll)), "step3_nll: Sum of squares, including step1_nll")

    if (nzchar(Sys.getenv('G3_TEST_TMB'))) {
        param_template <- attr(model_cpp, "parameter_template")
        param_template$value <- params[param_template$switch]
        gadget3:::ut_tmb_r_compare(model_fn, model_tmb, param_template)
    }
})
