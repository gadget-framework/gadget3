<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>G3 stock_* transformation functions — step • gadget3</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="G3 stock_* transformation functions — step"><meta property="og:description" content="Additional meta-functions to help manage writing stock-handling actions."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gadget3</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.999</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/model-debugging.html">Debugging a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/model_structure.html">Structure of a gadget3 model</a>
    </li>
    <li>
      <a href="../articles/tmb-gotchas.html">Gotchas and quirks of TMB</a>
    </li>
    <li>
      <a href="../articles/writing_actions.html">Writing G3 Actions</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>G3 stock_* transformation functions</h1>
    
    <div class="hidden name"><code>step.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Additional meta-functions to help manage writing stock-handling actions.</p>
    </div>


    <div id="details">
    <h2>Details</h2>
    <p>Whilst used as functions, these functions alter the code output of the model,
  rather than appearing directly. They make it easier to write code that can
  handle stocks generically without having to worry about renaming and stock
  dimensions.</p>
<p>The transformation itself is managed by <code>g3_step</code>(), which all actions use.</p>
    </div>
    <div id="debug-label">
    <h2>debug_label</h2>
    <p>Add a comment to the code to act as a label for that step, when producing an
  outline of the model. There shouldn't be more than one <code>debug_label</code>
  call in a step.</p>
<p>Models compiled with <code>trace = TRUE</code> will print the resultant string to stdout.</p>
<p></p><div class="section">
<h3 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h3>
<p>Any number of character strings, or <a href="stock.html">g3_stock</a> variables. The latter
    will be replaced with the final name.</p>
</div>

<p></p><div class="section">
<h3 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; prey_stock &lt;- g3_stock('herring', 1:3) |&gt; g3s_age(1,3)
&gt;  gadget3:::g3_step(~debug_trace("Zero ", stock, "-", prey_stock, " biomass-consuming counter"))
~debug_trace("Zero halibut-herring biomass-consuming counter")</code></pre></div>

<p></p>
</div>

    </div>
    <div id="debug-trace">
    <h2>debug_trace</h2>
    <p>Identical to debug_label, but not considered a "label", just a code
  comment, so any number of calls can be added.</p>
    </div>
    <div id="stock-assert">
    <h2>stock_assert</h2>
    <p><code>stock_assert(expression, message, message/stock-var, ...)</code></p>
<p>Assert that <var>expression</var> is true, if not abort with a message.</p>
<p></p><div class="section">
<h3 id="examples-1">Examples<a class="anchor" aria-label="anchor" href="#examples-1"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; gadget3:::g3_step(~stock_assert(stock_with(stock, all(is.finite(stock__num))), stock, "__num became NaN/Inf"))
~assert_msg(~all(is.finite(halibut__num)), "halibut__num became NaN/Inf")</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-reshape">
    <h2>stock_reshape</h2>
    <p><code>stock_reshape(dest_stock, expression)</code></p>
<p>Output <var>expression</var> with it's length structure reshaped to match
  <var>dest_stock</var>. The source stock is considered to be the first one
  found in <var>expression</var></p>
<p>How this is achieved depends on the difference. If the source and
  destination match then this is a no-op. Otherwise a transformation
  matrix is generated and included into the model.</p>
<p></p><div class="section">
<h3 id="examples-2">Examples<a class="anchor" aria-label="anchor" href="#examples-2"></a></h3>
<p><code>stock_reshape(output_stock, stock_ss(input_stock__transitioning_num))</code></p>
</div>

    </div>
    <div id="stock-ss">
    <h2>stock_ss</h2>
    <p><code>stock_ss(stock_var, [ dimname = override, dimname = override, ... ])</code></p>
<p>Subsets <var>stock_var</var> to get a length vector for the current iteration
  of stock_iterate(). If <var>dimname</var>s are supplied, then these
  dimensions overwritten with the suppled override, which could be a missing
  value, to preserve a dimension. See final example.</p>
<p></p><div class="section">
<h3 id="examples-3">Examples<a class="anchor" aria-label="anchor" href="#examples-3"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; stock__num &lt;- gadget3:::stock_instance(stock)
&gt; gadget3:::g3_step(~stock_iterate(stock, { x &lt;- x + stock_ss(stock__num) }))
~for (age in seq(halibut__minage, halibut__maxage, by = 1)) g3_with(
  halibut__age_idx := g3_idx(age - halibut__minage + 1L), {
    x &lt;- x + stock__num[, halibut__age_idx]
  })</code></pre></div>

<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10) |&gt; g3s_livesonareas(1)
&gt; stock__num &lt;- gadget3:::stock_instance(stock)
&gt; gadget3:::g3_step(~stock_ss(stock__num, area = 5)),
~stock__num[, stock__age_idx, 5]
&gt; gadget3:::g3_step(~stock_ss(stock__num, age = i + 1))
~stock__num[, i + 1, stock__area_idx]
&gt; gadget3:::g3_step(~stock_ss(stock__num, area = , age = j))
~stock__num[, j, ]</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-inv">
    <h2>stock_inv</h2>
    <p><code>stock_ss(stock_var, [ dimname, dimname, ... ])</code></p>
<p>like stock_ss(), but subset only the mentioned <var>dimname</var>s.</p>
<p></p><div class="section">
<h3 id="examples-4">Examples<a class="anchor" aria-label="anchor" href="#examples-4"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10) |&gt; g3s_livesonareas(1)
&gt; gadget3:::g3_step(~gadget3:::g3_step(~stock_ssinv(stock, 'age')))
~gadget3:::g3_step(~stock[, stock__age_idx, ])
&gt; gadget3:::g3_step(~gadget3:::g3_step(~stock_ssinv(stock, 'area')))
~gadget3:::g3_step(~stock[, , stock__area_idx])</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-switch">
    <h2>stock_switch</h2>
    <p><code>stock_ss(stock, stock_name1 = expr, stock_name2 = expr, ... [ default ])</code></p>
<p>Switch based on name of <var>stock</var>, returning the relevant <var>expr</var> or
  <var>default</var>. If no default supplied, then an unknown stock is an error.</p>
<p><var>expr</var> is implicitly wrapped with <code>stock_with(stock, ...)</code>,
  so any references to the stock variable will work. If only default is provided,
  then this is identical to calling <code>stock_with</code>.</p>
<p></p><div class="section">
<h3 id="examples-5">Examples<a class="anchor" aria-label="anchor" href="#examples-5"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) ; fleet_stock &lt;- g3_fleet('igfs')
&gt; gadget3:::g3_step(~stock_switch(stock, halibut = 2, herring = 3, -1))
~2
&gt; gadget3:::g3_step(~stock_switch(fleet_stock, halibut = 2, herring = 3, -1))
~-1
&gt; gadget3:::g3_step(~stock_switch(stock, halibut = stock__midlen, -1))
~halibut__midlen</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-with">
    <h2>stock_with</h2>
    <p><code>stock_with(stock, expr)</code></p>
<p>Replaced with <var>expr</var> but with all stock variables of <var>stock</var> renamed
  with their final name. This is generally needed when not iterating over a
  stock, but e.g. zeroing or summing the whole thing.</p>
<p></p><div class="section">
<h3 id="examples-6">Examples<a class="anchor" aria-label="anchor" href="#examples-6"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10)
&gt; gadget3:::g3_step(~stock_with(stock, sum(stock__num)))
~sum(halibut__num)</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-iterate">
    <h2>stock_iterate</h2>
    <p><code>stock_iterate(stock, expr)</code></p>
<p>Wrap <var>expr</var> with the code to iterate over each length vector in
  <var>stock</var>, accessed using <code>stock_ss(stock)</code></p>
<p>Current values for each dimension will be available as variables,
  e.g. <code>area</code>, <code>age</code>, and can be used in formulae.</p>
<p></p><div class="section">
<h3 id="examples-7">Examples<a class="anchor" aria-label="anchor" href="#examples-7"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; gadget3:::g3_step(~stock_iterate(stock, x &lt;- x + stock_ss(stock__num)))
~for (age in seq(halibut__minage, halibut__maxage, by = 1)) g3_with(`:=`(halibut__age_idx,
    g3_idx(age - halibut__minage + 1L)), x &lt;- x + halibut__num[, halibut__age_idx])</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-intersect">
    <h2>stock_intersect</h2>
    <p><code>stock_intersect(stock, expr)</code></p>
<p>Wrap <var>expr</var> with the code to intersect all dimensions with
  the dimensions of an outer stock_iterate().</p>
<p></p><div class="section">
<h3 id="examples-8">Examples<a class="anchor" aria-label="anchor" href="#examples-8"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; prey_stock &lt;- g3_stock('herring', 1:3) |&gt; g3s_age(1,3)
&gt; gadget3:::g3_step(~stock_iterate(stock, stock_intersect(prey_stock, x &lt;- x + stock_ss(stock__num) + stock_ss(prey_stock__num) )))
~for (age in seq(halibut__minage, halibut__maxage, by = 1)) if (age &gt;=
    herring__minage &amp;&amp; age &lt;= herring__maxage) g3_with(
      halibut__age_idx := g3_idx(age - halibut__minage + 1L),
      herring__age_idx := g3_idx(age - herring__minage + 1L), {
        x &lt;- x + halibut__num[, halibut__age_idx] + herring__num[, herring__age_idx]
      })</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-interact">
    <h2>stock_interact</h2>
    <p><code>stock_interact(stock, expr, prefix = prefix)</code></p>
<p>Wrap <var>expr</var> with the code to interact with the dimensions of an outer
  stock_iterate(). Interact means to intersect over area, but try the
  combinatoral explosion of all other dimensions, i.e. what would make most
  sense when 2 stocks interact in a predator-prey relationship.</p>
<p>Additional variables will be prefixed with <var>prefix</var>.</p>
<p></p><div class="section">
<h3 id="examples-9">Examples<a class="anchor" aria-label="anchor" href="#examples-9"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock('halibut', 1:10) |&gt; g3s_age(1,10)
&gt; prey_stock &lt;- g3_stock('herring', 1:3) |&gt; g3s_age(1,3)
&gt; gadget3:::g3_step(~stock_iterate(stock, stock_interact(prey_stock, {
    x &lt;- x + stock_ss(stock__num) + stock_ss(prey_stock__num)}, prefix = "prey" )))
~for (age in seq(halibut__minage, halibut__maxage, by = 1)) g3_with(
  halibut__age_idx := g3_idx(age - halibut__minage + 1L), {
    for (prey_age in seq(herring__minage, herring__maxage, by = 1)) g3_with(
      herring__age_idx := g3_idx(prey_age - herring__minage + 1L), {
        x &lt;- x + halibut__num[, halibut__age_idx] + herring__num[, herring__age_idx]
      }
  }))</code></pre></div>

<p></p>
</div>

    </div>
    <div id="stock-param">
    <h2>stock_param</h2>
    <p><code>stock_param(stock, name, name_part = NULL, ...)</code></p>
<p>Convert to a call to <a href="language.html">g3_param</a>, prefixing the <var>name</var> with the stock name.
  If <var>name_part</var> given, only use that part of the stock name.</p>
<p>All other args passed through to <a href="language.html">g3_param</a>.</p>
<p></p><div class="section">
<h3 id="examples-10">Examples<a class="anchor" aria-label="anchor" href="#examples-10"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock(c(species = 'halibut', 'imm'), 1:10) |&gt; g3s_age(1,10)
&gt; gadget3:::g3_step(~stock_param(stock, 'K'))
~g3_param("halibut_imm.K")
&gt; gadget3:::g3_step(~stock_param(stock, 'K', name_part = 'species'))
~g3_param("halibut.K")</code></pre></div><p></p>
</div>

    </div>
    <div id="stock-param-table">
    <h2>stock_param_table</h2>
    <p><code>stock_param_table(stock, name, name_part = NULL, table_defn, ...)</code></p>
<p>Convert to a call to <a href="language.html">g3_param_table</a>, prefixing the <var>name</var> with the stock name.
  If <var>name_part</var> given, only use that part of the stock name.</p>
<p>The <var>table_defn</var> will have any instances of <var>stock</var> replaced using stock_with().</p>
<p>All other args passed through to <a href="language.html">g3_param_table</a>.</p>
<p></p><div class="section">
<h3 id="examples-11">Examples<a class="anchor" aria-label="anchor" href="#examples-11"></a></h3>


<div class="sourceCode"><pre><code>&gt; stock &lt;- g3_stock(c(species = 'halibut', 'imm'), 1:10) |&gt; g3s_age(1,10)
&gt; gadget3:::g3_step(~stock_param_table(stock, 'K', expand.grid(year = 2000:2004)))
~g3_param_table("halibut_imm.K", expand.grid(year = 2000:2004))
&gt; gadget3:::g3_step(~stock_param_table(stock, 'K', expand.grid(age = seq(stock__minage, stock__maxage))))
~g3_param_table("halibut_imm.K", expand.grid(age = seq(halibut_imm__minage,
    halibut_imm__maxage)))</code></pre></div><p></p>
</div>

    </div>

  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Jamie Lentin, Bjarki Thor Elvarsson.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

      </footer></div>

  


  

  </body></html>

